; define namespace

(define-namespace 'test (sig-keyset) (sig-keyset))
(env-data { 'ns: 'test })

; load dependencies

(load "../../groth16-verifier/src/lib.repl")
(load "../../plonk-verifier/src/lib.repl")
(load "../../poseidon/src/lib.repl")
(load "../../merkle-tree/src/lib.repl")

(load "kip/0005/fungible-v2.pact")
(load "kip/0005/fungible-v2-reference.pact")
(load "kip/native/coin.pact")
(load "kip/0011/poly-fungible-v1.pact")
(load "kip/0011/fungible-util.pact")
(load "kip/0011/poly-fungible-reference.pact")

(load "../src/contract.pact")

; setup

(create-table coin.coin-table)
(create-table fungible-v2-reference.ledger)

(env-data 
{ "user1" : ["user1-keys"]
, "user2" : ["user2-keys"]
, "user3" : ["user3-keys"]
, "user4" : ["user4-keys"]
})

(env-keys ["user1-keys", "user2-keys", "user3-keys", "user4-keys"])

(coin.create-account "sender-address" (read-keyset "user1"))
(coin.create-account "opact-gas-payer" (read-keyset "user4"))
(fungible-v2-reference.create-account "sender-address" (read-keyset "user1"))
(fungible-v2-reference.create-account "recipient-address" (read-keyset "user2"))
(fungible-v2-reference.create-account "opact-contract" (read-keyset "user3"))

(test-capability (coin.CREDIT "sender-address"))
(test-capability (coin.CREDIT "opact-gas-payer"))
(test-capability (fungible-v2-reference.CREDIT "sender-address"))
(test-capability (fungible-v2-reference.CREDIT "recipient-address"))
(test-capability (fungible-v2-reference.CREDIT "opact-contract"))

(coin.credit "sender-address" (read-keyset "user1") 100.0)
(coin.credit "opact-gas-payer" (read-keyset "user4") 100.0)
(fungible-v2-reference.credit "sender-address" (read-keyset "user1") 100.0)
(fungible-v2-reference.credit "recipient-address" (read-keyset "user2") 100.0)
(fungible-v2-reference.credit "opact-contract" (read-keyset "user3") 100.0)

; fungible tokens - deposit

(test-capability (fungible-v2-reference.TRANSFER "sender-address" "opact-contract" 10.0))
(test-capability (coin.TRANSFER "sender-address" "opact-gas-payer" 2.0))

(merkle.insert-leaf "1") ; -> OKCZZGtqfiSv896M7Mz-xp_LHrhOA4t-IlBndTuL-6c

(env-gasmodel "table")
(env-gaslimit 10000000)
(env-gas 0)

(env-data { 
    "token-instance": {"refName": {"name": "fungible-v2-reference","namespace": "test"},
                       "refSpec": [{"name": "fungible-v2","namespace": "test"}]}
})

(transact {
    ; args
    "root": "OKCZZGtqfiSv896M7Mz-xp_LHrhOA4t-IlBndTuL-6c",
    "outputCommitments":["4" "5"],
    "publicAmount":10.0,
    "extDataHash": "5Q1vrajemSYJkjNavhhXrBeonRnAUJ3pMV_PEBhyyEM",
    "tokenHash":"xREP4WsVRQ0HU5X-wjW1H2KhpA2RM2Qtc-T7K9XFvD0"
} { ; groth16 proof
    "public_values":[33],
    "a":{"x":19817713765959346549871130524470948269519566174538742939036152399142416600582,"y":20982929616821238786000656044488294849631590234739190402911135613417078219455},
    "b":{"x":[8586005240412506756232549016262713541937049887946846965391911108745443737983 9587493727140983135209670127248213932838995815439324182670188972155479051173],
         "y":[3304759387246915019533575974791000179823243043816637947321468390345277807091 10323717147005767368120555592716346202516177652934252937639685195636233739862]},
    "c":{"x":4016739862039177466188094288526125375400410920627291835204997875349870930371,"y":8109450981714180662240853592027233497894520695072849576218650369542745992730}
} { ; extData
    "sender": "sender-address",
    "recipient":"recipient-address",
    "extAmount":10.0,
    "relayer":1,
    "fee":1.0,
    "encryptedOutput1":1,
    "encryptedOutput2":1
} { ; token-spec
    "id": "",
    "refName": {"name": "fungible-v2-reference","namespace": "test"},
    "refSpec": {"name": "fungible-v2","namespace": "test"}
})

(print {"Total gas": (env-gas)})

(expect "deposit - sender balance (native)" 99.0 (coin.get-balance "sender-address"))
(expect "deposit - gas payer balance (native)" 101.0 (coin.get-balance "opact-gas-payer"))
(expect "deposit - sender balance (fungible)" 90.0 (fungible-v2-reference.get-balance "sender-address"))
(expect "deposit - contract balance (fungible)" 110.0 (fungible-v2-reference.get-balance "opact-contract"))
(expect "deposit - recipient balance (fungible)" 100.0 (fungible-v2-reference.get-balance "recipient-address"))

;  ;; setup

;  (create-table poly-fungible-reference.ledger)
;  (create-table poly-fungible-reference.supplies)

;  (env-data 
;      { "user1" : ["user1-keys"]
;      , "user2" : ["user2-keys"]
;      , "user3" : ["user3-keys"]
;      })

;  (poly-fungible-reference.create-account "1" "sender-address" (read-keyset "user1"))
;  (poly-fungible-reference.create-account "1" "recipient-address" (read-keyset "user2"))
;  (poly-fungible-reference.create-account "1" "opact-contract" (read-keyset "user3"))

;  (test-capability (poly-fungible-reference.CREDIT "1" "sender-address"))
;  (test-capability (poly-fungible-reference.CREDIT "1" "recipient-address"))
;  (test-capability (poly-fungible-reference.CREDIT "1" "opact-contract"))
;  (test-capability (poly-fungible-reference.TRANSFER "1" "sender-address" "recipient-address" 1.0))
;  (test-capability (poly-fungible-reference.TRANSFER "1" "sender-address" "opact-contract" 11.0))

;  (poly-fungible-reference.credit "1" "sender-address" (read-keyset "user1") 100.0)
;  (poly-fungible-reference.credit "1" "recipient-address" (read-keyset "user2") 100.0)
;  (poly-fungible-reference.credit "1" "opact-contract" (read-keyset "user3") 100.0)

;  ;; poly-fungible tokens - deposit

;  (merkle.insert-leaf "1") ; -> QtORzD3f7dXWEeDvbOLDXnnyWKujpDsBNo5EciKFGfw

;  (env-data { 
;      "token-instance": {"refName": {"name": "poly-fungible-reference","namespace": "test"},
;                         "refSpec": [{"name": "poly-fungible-v1","namespace": "test"}]}
;  })

;  (env-gas 0)

;  (transact {
;      ; args
;      "root": "QtORzD3f7dXWEeDvbOLDXnnyWKujpDsBNo5EciKFGfw",
;      "outputCommitments":["4" "5"],
;      "publicAmount":10.0,
;      "extDataHash": "PGSiheYzABVmQ--6aCKuZ_gTnAR_TXdij_TXTDiDHhg",
;      "tokenHash":"Xm4yflWY21e2hUIAdw2NJtlt7UYRbOd_SJXqZMPMmhw"
;  } { ; groth16 proof
;      "public_values":[1141433],
;      "a":{"x":17758346808131630550346246791959405926266116215987855687720311415390233061279,"y":9841596890253595012939177643002382360676856324792852596114091162314686062385},
;      "b":{"x":[2123813079138679983302262487781537761378191587140304703166022526363723202552 4363831879607184469128208731669025007461869418430388828110916691451922814511],
;           "y":[7752640082083603287246749482898424423484286106090706457076842557282700966200 4037163165778918587353231649442402356585761347199898523467629631784727377286]},
;      "c":{"x":12696920624842071155708804937443195054540785876282266663846946663196195897306,"y":3980807484315559301805617955896672724421102193465583438132804153417765298073}
;  } { ; extData
;      "sender": "sender-address",
;      "recipient":"recipient-address",
;      "extAmount":11.0,
;      "relayer":1,
;      "fee":1.0,
;      "encryptedOutput1":1,
;      "encryptedOutput2":1
;  } { ; token-spec
;      "id": "1",
;      "refName": {"name": "poly-fungible-reference","namespace": "test"},
;      "refSpec": {"name": "poly-fungible-v1","namespace": "test"}
;  })

;  (print {"Total gas": (env-gas)})

;  (expect "poly-fungible token - deposit - sender balance" 89.0 (poly-fungible-reference.get-balance "1" "sender-address"))
;  (expect "poly-fungible token - deposit - contract balance" 111.0 (poly-fungible-reference.get-balance "1" "opact-contract"))
;  (expect "poly-fungible token - deposit - recipient balance" 100.0 (poly-fungible-reference.get-balance "1" "recipient-address"))

; fungible tokens - withdraw

(test-capability (fungible-v2-reference.TRANSFER "opact-contract" "recipient-address" 10.0))

(env-gasmodel "table")
(env-gaslimit 10000000)
(env-gas 0)

(env-data { 
    "token-instance": {"refName": {"name": "fungible-v2-reference","namespace": "test"},
                       "refSpec": [{"name": "fungible-v2","namespace": "test"}]}
})

(transact {
    ; args
    "root": "OKCZZGtqfiSv896M7Mz-xp_LHrhOA4t-IlBndTuL-6c",
    "outputCommitments":["4" "5"],
    "publicAmount": 21888242871839275222246405745257275088548364400416034343698204186575808495627.0,
    "extDataHash": "ycMvXYGguNryT9m7iREcHwZSWK2S4YEjaqyHpyfw4Xw",
    "tokenHash":"xREP4WsVRQ0HU5X-wjW1H2KhpA2RM2Qtc-T7K9XFvD0"
} { ; groth16 proof
    "public_values":[1141433],
    "a":{"x":17758346808131630550346246791959405926266116215987855687720311415390233061279,"y":9841596890253595012939177643002382360676856324792852596114091162314686062385},
    "b":{"x":[2123813079138679983302262487781537761378191587140304703166022526363723202552 4363831879607184469128208731669025007461869418430388828110916691451922814511],
        "y":[7752640082083603287246749482898424423484286106090706457076842557282700966200 4037163165778918587353231649442402356585761347199898523467629631784727377286]},
    "c":{"x":12696920624842071155708804937443195054540785876282266663846946663196195897306,"y":3980807484315559301805617955896672724421102193465583438132804153417765298073}
} { ; extData
    "sender": "sender-address",
    "recipient":"recipient-address",
    "extAmount":-10.0,
    "relayer":1,
    "fee":1.0,
    "encryptedOutput1":1,
    "encryptedOutput2":1
} { ; token-spec
    "id": "",
    "refName": {"name": "fungible-v2-reference","namespace": "test"},
    "refSpec": {"name": "fungible-v2","namespace": "test"}
})

(print {"Total gas": (env-gas)})

(expect "withdraw - sender balance (native)" 98.0 (coin.get-balance "sender-address"))
(expect "withdraw - gas payer balance (native)" 102.0 (coin.get-balance "opact-gas-payer"))

(expect "withdraw - sender balance (fungible)" 90.0 (fungible-v2-reference.get-balance "sender-address"))
(expect "withdraw - contract balance (fungible)" 100.0 (fungible-v2-reference.get-balance "opact-contract"))
(expect "withdraw - recipient balance (fungible)" 110.0 (fungible-v2-reference.get-balance "recipient-address"))