; define namespace

(define-namespace 'test (sig-keyset) (sig-keyset))
(env-data { 'ns: 'test })

; load dependencies

(load "../../groth16-verifier/src/lib-1x2.repl")
(load "../../groth16-verifier/src/lib-2x2.repl")
(load "../../groth16-verifier/src/lib-3x2.repl")
(load "../../groth16-verifier/src/lib-4x2.repl")
(load "../../groth16-verifier/src/lib-5x2.repl")
(load "../../groth16-verifier/src/lib-6x2.repl")
(load "../../groth16-verifier/src/lib-7x2.repl")
(load "../../groth16-verifier/src/lib-8x2.repl")
(load "../../groth16-verifier/src/lib-9x2.repl")
(load "../../groth16-verifier/src/lib-10x2.repl")

; (load "../../plonk-verifier/src/lib.repl")
(load "../../poseidon/src/lib.repl")
(load "../../merkle-tree/src/lib.repl")

(load "kip/0005/fungible-v2.pact")
(load "kip/0005/fungible-v2-reference.pact")
(load "kip/native/coin.pact")
(load "kip/0011/poly-fungible-v1.pact")
(load "kip/0011/fungible-util.pact")
(load "kip/0011/poly-fungible-reference.pact")

(load "../src/contract.pact")

; setup

(create-table coin.coin-table)
(create-table fungible-v2-reference.ledger)

(env-data 
{ "user1" : ["user1-keys"]
, "user2" : ["user2-keys"]
, "user3" : ["user3-keys"]
, "user4" : ["user4-keys"]
})

(env-keys ["user1-keys", "user2-keys", "user3-keys", "user4-keys"])

(coin.create-account "sender-address" (read-keyset "user1"))
(coin.create-account "opact-gas-payer" (read-keyset "user4"))
(fungible-v2-reference.create-account "sender-address" (read-keyset "user1"))
(fungible-v2-reference.create-account "recipient-address" (read-keyset "user2"))
(fungible-v2-reference.create-account "opact-contract" (read-keyset "user3"))

(test-capability (coin.CREDIT "sender-address"))
(test-capability (coin.CREDIT "opact-gas-payer"))
(test-capability (fungible-v2-reference.CREDIT "sender-address"))
(test-capability (fungible-v2-reference.CREDIT "recipient-address"))
(test-capability (fungible-v2-reference.CREDIT "opact-contract"))

(coin.credit "sender-address" (read-keyset "user1") 100.0)
(coin.credit "opact-gas-payer" (read-keyset "user4") 100.0)
(fungible-v2-reference.credit "sender-address" (read-keyset "user1") 100.0)
(fungible-v2-reference.credit "recipient-address" (read-keyset "user2") 100.0)
(fungible-v2-reference.credit "opact-contract" (read-keyset "user3") 100.0)

; fungible tokens - deposit

(test-capability (fungible-v2-reference.TRANSFER "sender-address" "opact-contract" 10.0))
(test-capability (coin.TRANSFER "sender-address" "opact-gas-payer" 2.0))

(merkle.insert-leaf 0) ; -> 18366138217714291923534712849449091358386817997964088830897385671725623871073

(env-gasmodel "table")
(env-gaslimit 10000000)
(env-gas 0)

(env-data { 
    "token-instance": {"refName": {"name": "fungible-v2-reference","namespace": "test"},
                       "refSpec": [{"name": "fungible-v2","namespace": "test"}]}
})

(transact {
    ; args
    "root": 18366138217714291923534712849449091358386817997964088830897385671725623871073,
    "outputCommitments":[4 5],
    "publicAmount":10.0,
    "extDataHash": "eUt4ZUF8eWBjrmfr5gc5bKtgwEuZyYG_4rsl9DAcMhk",
    "tokenHash":"xREP4WsVRQ0HU5X-wjW1H2KhpA2RM2Qtc-T7K9XFvD0"
} { ; groth16 proof
    "public_values":[5097715052237145403753365704898254467169137625210256492956965949270430045 10350054029334029104721836436197614298271599814974025951759768887472959204491 8880212327543797734391566362872821399417931236479047492409675925327395362024 6744756488845918878339475731082062348289674403192928430312475229224416054163 11447887161685273325229383682033758855034454108223333399257174474224042460477 20085879863141481154416816762505004939695895115007481593493468713550477118072 1491673331617618272981045375721765540778861924763498414377149116092375404182 1409566157580977860959833662881925553878710509003 1076349462536313652575937474535332016951960024124 814843937149388495664711784579302082226637396667434303269754721330180190802],
    "a":{"x":17901042678392254749009477662444348028409443811053697007027715576663992903799,"y":17048225545256157163674902826671998880176775729930869352951888784634602972577},
    "b":{"x":[4434085511194832277146281817017632276264964685517905758544892252867374596754 18032823362937264937199773264971671344432187031187091034703593895639367647694],
         "y":[9439696666055659947675970120722790572303540575063261557626202383522078275740 20091390898922485508524257678012892745061123293603606701407411013078735614039]},
    "c":{"x":17910219481298589721088687155746307889801437978994146636715821557888886556540,"y":3644328300856086571465919298625535607457024633955676512087523130907764371638}
} { ; extData
    "sender": "sender-address",
    "recipient":"recipient-address",
    "extAmount":10.0,
    "relayer":1,
    "fee":1.0,
    "encryptedOutput1":1,
    "encryptedOutput2":1,
    "encryptedValue":1
} { ; token-spec
    "id": "",
    "refName": {"name": "fungible-v2-reference","namespace": "test"},
    "refSpec": {"name": "fungible-v2","namespace": "test"}
})

(print {"Total gas": (env-gas)})

(expect "deposit - sender balance (native)" 99.0 (coin.get-balance "sender-address"))
(expect "deposit - gas payer balance (native)" 101.0 (coin.get-balance "opact-gas-payer"))
(expect "deposit - sender balance (fungible)" 90.0 (fungible-v2-reference.get-balance "sender-address"))
(expect "deposit - contract balance (fungible)" 110.0 (fungible-v2-reference.get-balance "opact-contract"))
(expect "deposit - recipient balance (fungible)" 100.0 (fungible-v2-reference.get-balance "recipient-address"))

;  ;; setup

;  (create-table poly-fungible-reference.ledger)
;  (create-table poly-fungible-reference.supplies)

;  (env-data 
;      { "user1" : ["user1-keys"]
;      , "user2" : ["user2-keys"]
;      , "user3" : ["user3-keys"]
;      })

;  (poly-fungible-reference.create-account "1" "sender-address" (read-keyset "user1"))
;  (poly-fungible-reference.create-account "1" "recipient-address" (read-keyset "user2"))
;  (poly-fungible-reference.create-account "1" "opact-contract" (read-keyset "user3"))

;  (test-capability (poly-fungible-reference.CREDIT "1" "sender-address"))
;  (test-capability (poly-fungible-reference.CREDIT "1" "recipient-address"))
;  (test-capability (poly-fungible-reference.CREDIT "1" "opact-contract"))
;  (test-capability (poly-fungible-reference.TRANSFER "1" "sender-address" "recipient-address" 1.0))
;  (test-capability (poly-fungible-reference.TRANSFER "1" "sender-address" "opact-contract" 11.0))

;  (poly-fungible-reference.credit "1" "sender-address" (read-keyset "user1") 100.0)
;  (poly-fungible-reference.credit "1" "recipient-address" (read-keyset "user2") 100.0)
;  (poly-fungible-reference.credit "1" "opact-contract" (read-keyset "user3") 100.0)

;  ;; poly-fungible tokens - deposit

;  (merkle.insert-leaf "1") ; -> QtORzD3f7dXWEeDvbOLDXnnyWKujpDsBNo5EciKFGfw

;  (env-data { 
;      "token-instance": {"refName": {"name": "poly-fungible-reference","namespace": "test"},
;                         "refSpec": [{"name": "poly-fungible-v1","namespace": "test"}]}
;  })

;  (env-gas 0)

;  (transact {
;      ; args
;      "root": "QtORzD3f7dXWEeDvbOLDXnnyWKujpDsBNo5EciKFGfw",
;      "outputCommitments":["4" "5"],
;      "publicAmount":10.0,
;      "extDataHash": "PGSiheYzABVmQ--6aCKuZ_gTnAR_TXdij_TXTDiDHhg",
;      "tokenHash":"Xm4yflWY21e2hUIAdw2NJtlt7UYRbOd_SJXqZMPMmhw"
;  } { ; groth16 proof
;      "public_values":[1141433],
;      "a":{"x":17758346808131630550346246791959405926266116215987855687720311415390233061279,"y":9841596890253595012939177643002382360676856324792852596114091162314686062385},
;      "b":{"x":[2123813079138679983302262487781537761378191587140304703166022526363723202552 4363831879607184469128208731669025007461869418430388828110916691451922814511],
;           "y":[7752640082083603287246749482898424423484286106090706457076842557282700966200 4037163165778918587353231649442402356585761347199898523467629631784727377286]},
;      "c":{"x":12696920624842071155708804937443195054540785876282266663846946663196195897306,"y":3980807484315559301805617955896672724421102193465583438132804153417765298073}
;  } { ; extData
;      "sender": "sender-address",
;      "recipient":"recipient-address",
;      "extAmount":11.0,
;      "relayer":1,
;      "fee":1.0,
;      "encryptedOutput1":1,
;      "encryptedOutput2":1
;  } { ; token-spec
;      "id": "1",
;      "refName": {"name": "poly-fungible-reference","namespace": "test"},
;      "refSpec": {"name": "poly-fungible-v1","namespace": "test"}
;  })

;  (print {"Total gas": (env-gas)})

;  (expect "poly-fungible token - deposit - sender balance" 89.0 (poly-fungible-reference.get-balance "1" "sender-address"))
;  (expect "poly-fungible token - deposit - contract balance" 111.0 (poly-fungible-reference.get-balance "1" "opact-contract"))
;  (expect "poly-fungible token - deposit - recipient balance" 100.0 (poly-fungible-reference.get-balance "1" "recipient-address"))

; fungible tokens - withdraw






(test-capability (fungible-v2-reference.TRANSFER "opact-contract" "recipient-address" 10.0))

(env-gasmodel "table")
(env-gaslimit 10000000)
(env-gas 0)

(env-data { 
    "token-instance": {"refName": {"name": "fungible-v2-reference","namespace": "test"},
                       "refSpec": [{"name": "fungible-v2","namespace": "test"}]}
})

(transact {
    ; args
    "root": 18366138217714291923534712849449091358386817997964088830897385671725623871073,
    "outputCommitments":[4 5],
    "publicAmount": 21888242871839275222246405745257275088548364400416034343698204186575808495627.0,
    "extDataHash": "j_T06jcvKdbC4f_zB2xkDtN1-mYlR4sGiZ72gemFDlk",
    "tokenHash":"xREP4WsVRQ0HU5X-wjW1H2KhpA2RM2Qtc-T7K9XFvD0"
} { ; groth16 proof
    "public_values":[6549528558437796551109796215651469590577289298285154522446750263957848217990 9340507213909893570075533458249420519277410455902050647058477812654729690871 3836484959209379530897253280930481664044991636501750449284507664334663619803 3310042387063546051694339821566389833437850998173760495616000858241156362449 13924262072728720917501484489183006849613902356672750964253617819963275417535 17331021142945595148003703207469365834071507571641831262582918266535631794863 7486776175838865209771455585678644242478266678596657713703262325949588930608 1454133245195396932460760613671278372813553831461 1200174454565686355742945407856392826315842700977 4592424182211517880640117801487621447541670828836116903220358463876373231471],
    "a":{"x":12164292933485601233815401389865865768076956758778525696943986049330812280811,"y":148156805490929500155342626819885615932831719484138700821655809730274224518},
    "b":{"x":[8565763447153129650963651970913324634102820393585688003808392088532410551486 4057642463456610909530169451152346322741370436053630738073125029089918919051],
        "y":[5139674024656230324954454149962948460713552941439408421556823687316849103099 2787615627075675709229748956401315674998600271044382362867289040397766488473]},
    "c":{"x":11973567014970121358007049185582855204989331702222051249273563650100952584514,"y":12157157589678748850774352572000384256255550701141155806931747671010347592989}
} { ; extData
    "sender": "sender-address",
    "recipient":"recipient-address",
    "extAmount":-10.0,
    "relayer":1,
    "fee":1.0,
    "encryptedOutput1":1,
    "encryptedOutput2":1,
    "encryptedValue":1
} { ; token-spec
    "id": "",
    "refName": {"name": "fungible-v2-reference","namespace": "test"},
    "refSpec": {"name": "fungible-v2","namespace": "test"}
})

(print {"Total gas": (env-gas)})

(expect "withdraw - sender balance (native)" 98.0 (coin.get-balance "sender-address"))
(expect "withdraw - gas payer balance (native)" 102.0 (coin.get-balance "opact-gas-payer"))

(expect "withdraw - sender balance (fungible)" 90.0 (fungible-v2-reference.get-balance "sender-address"))
(expect "withdraw - contract balance (fungible)" 100.0 (fungible-v2-reference.get-balance "opact-contract"))
(expect "withdraw - recipient balance (fungible)" 110.0 (fungible-v2-reference.get-balance "recipient-address"))