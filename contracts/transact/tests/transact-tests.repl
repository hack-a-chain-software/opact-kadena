(load "kip/0005/fungible-v2.pact")
(load "kip/native/coin.pact")

; define namespace

(define-namespace 'kip (sig-keyset) (sig-keyset))
(define-namespace 'test (sig-keyset) (sig-keyset))
(define-namespace 'free (sig-keyset) (sig-keyset))
(define-namespace 'util (sig-keyset) (sig-keyset))

(env-keys ["user1-keys", "user2-keys", "user3-keys", "user4-keys"])

(env-data 
    { 'ns: 'free 
    , "user1" : ["user1-keys"]
    }
)

; load dependencies

(load "../../groth16-verifier/src/lib-1x2.repl")
(load "../../groth16-verifier/src/lib-2x2.repl")
(load "../../groth16-verifier/src/lib-3x2.repl")
(load "../../groth16-verifier/src/lib-4x2.repl")
(load "../../groth16-verifier/src/lib-5x2.repl")
(load "../../groth16-verifier/src/lib-6x2.repl")
(load "../../groth16-verifier/src/lib-7x2.repl")
(load "../../groth16-verifier/src/lib-8x2.repl")
(load "../../groth16-verifier/src/lib-9x2.repl")
(load "../../groth16-verifier/src/lib-10x2.repl")
(load "../../merkle-tree/src/lib.repl")

(define-keyset "free.opact-admin" (read-keyset "user1"))

(env-data { 'ns: 'test })

(load "kip/0005/fungible-v2-reference.pact")
(load "kip/0011/poly-fungible-v1.pact")
(load "kip/0013/manifest.pact")
(load "kip/0013/token-policy-v1.pact")
(load "kip/0013/poly-fungible-v2.pact")

(load "kip/0013/account-protocols-v1.pact")
(load "kip/0013/fungible-util.pact")
(load "kip/0013/poly-fungible-v2-reference.pact")
(load "kip/0011/fungible-util.pact")
(load "kip/0011/poly-fungible-reference.pact")

; setup

(create-table coin.coin-table)
(create-table fungible-v2-reference.ledger)

(load "../src/contract.pact")

(env-data 
{ "user1" : ["user1-keys"]
, "user2" : ["user2-keys"]
, "user3" : ["user3-keys"]
, "user4" : ["user4-keys"]
})

; --------------------------------------------------------
; Notes
; --------------------------------------------------------

; Simulate a transaction using opact contract with provided proof and external data
; For more information on how the proof is generated, see: https://github.com/iden3/snarkjs?tab=readme-ov-file#groth16-1
; The public values array contains the following values:
;  - root,
;  - subtree_root,
;  - nullifier,
;  - utxo_out_hash,
;  - token,
;  - delta,
;  - message_hash
; The external data is a JSON object that contains the sender, recipient, token type, token amount, and the encrypted output commitments
; - sender: This field represents the public key of the sender of the transaction;
; - recipient: This field represents the public key of the recipient of the transaction;
; - tokenType: This field represents the type of token being transferred. It can be "fungible-v2", "poly-fungible-v1" or "poly-fungible-v2";
; - tokenAmount: This field represents the amount of tokens being transferred in the transaction;
; - tokenId: This field represents the unique identifier of the token being transferred in case the token is non-fungible, if the token is fungible, this field should be an empty string; 
; - outputCommitments: This field represents the hashes of UTXOs (Unspent Transaction Outputs) that are being spent or "burned" in a transaction.
;       The hash is calculated based on the following structure.
;           export interface GetUtxoInterface {
;               token: string | bigint,
;               pubkey: string | bigint,
;               id?: string | number,
;               address?: string,
;               amount?: bigint | number,
;               receipt?: ReceiptInterface | null,
;           }

; - encryptedReceipts: This field represents the encrypted receipts that are being transferred in a transaction. 
;       It has the following structure:
;           export interface ReceiptInterface {
;               date: number,
;               amount: string,
;               sender: string,
;               address: string,
;               receiver: string,
;               id: string | number,
;               type: 'deposit' | 'withdraw',
;           }
;       The ability to decrypt `encryptedReceipts` depends on the nature of the transaction:
;           1. **Deposit Transactions**: For deposits, only the Opact wallet that made the deposit has the necessary decryption keys 
;               to access the encrypted receipt. This ensures that details of the deposit, such as the amount, sender, and transaction date, 
;               remain confidential and accessible only to the depositor.
;           2. **Internal Transfer Transactions**: In the case of transfers, two encrypted receipts are generated - one for the sender and one for the receiver.
;               Each party is provided with a receipt encrypted in such a way that only they can decrypt their respective receipt. 
;               This approach maintains the privacy of transaction details for both parties involved, allowing each to independently verify 
;               the transaction details pertinent to them.
;           3. **Withdraw Transactions**: For withdrawals, only the Opact wallet that initiated the withdraw has the capability to decrypt the 
;               encrypted receipt. This ensures that sensitive transaction details related to the withdrawal are kept secure and private, 
;               accessible only to the individual or entity making the withdrawal.

; - encryptedCommitments: This field represents the encrypted commitments that are being transferred in a transaction.
;       It has the following structure:
;           export interface GetUtxoInterface {
;               token: string | bigint,
;               pubkey: string | bigint,
;               id?: string | number,
;               address?: string,
;               amount?: bigint | number,
;               receipt?: ReceiptInterface | null,
;           }
;       The decryption of `encryptedCommitments` follows a privacy-centric model similar to that of `encryptedReceipts`, 
;       ensuring that sensitive data is accessible only to authorized parties. An `encryptedCommitment` represents an 
;       encrypted UTXO (Unspent Transaction Output) involved in a transaction.
;           1. **For Deposits**: Only the Opact wallet performing the deposit can decrypt the `encryptedCommitments` related to the transaction. 
;               This ensures the privacy of the UTXOs being added, allowing only the depositor to have visibility into the 
;               specific details of the UTXOs they are committing.

;           2. **For Internal Transfers**: In internal transfer transactions, `encryptedCommitments` are accessible to both the sender and the recipient. 
;               Each party receives an encrypted commitment relevant to their role in the transaction — one representing the UTXOs being spent
;               (by the sender) and another representing the UTXOs being received (by the recipient). 
;               This setup ensures that each party can verify the transaction details relevant to them without compromising the privacy of 
;               the UTXO details to outside parties.

;           3. **For Withdrawals**: When a withdrawal occurs, the `encryptedCommitments` associated with the UTXOs being withdrawn can only be
;               decrypted by the Opact wallet initiating the withdrawal. This ensures that the details of the UTXOs leaving the system are kept
;               private and secure, accessible solely to the withdrawing party.

; --------------------------------------------------------
; Test Cases
; --------------------------------------------------------

; [✗] Deposit Transaction (coin) | Invalid public amount
; [✗] Deposit Transaction (coin) | Invalid message hash
; [✗] Deposit Transaction (coin) | Invalid token
; [✗] Deposit Transaction (coin) | Amount is larger than maximum deposit amount
; [✗] Deposit Transaction (coin) | Invalid merkle root
; [✔] Deposit Transaction (coin) | Successful
; [✗] Deposit Transaction (coin) | Input is already spent
; [✔] Withdraw Transaction (coin) | Successful
; [✔] Internal Transfer Transaction (coin) | Successful
; [✔] Deposit Transaction (NFT) | Successful
; [✔] Withdraw Transaction (NFT) | Successful

; --------------------------------------------------------
; Setup
; --------------------------------------------------------

; Setup Fungible

(coin.create-account "opact-gas-payer" (read-keyset "user4"))

(coin.create-account "k:aaecdc57dd287ab576f48f7357f470fd41e0060e83197df1fe86c6866698c221" (read-keyset "user1"))
(test-capability (coin.CREDIT "k:aaecdc57dd287ab576f48f7357f470fd41e0060e83197df1fe86c6866698c221"))
(coin.credit "k:aaecdc57dd287ab576f48f7357f470fd41e0060e83197df1fe86c6866698c221" (read-keyset "user1") 100.0)

; Setup Poly-Fungible

(create-table poly-fungible-reference.ledger)
(create-table poly-fungible-reference.supplies)

(poly-fungible-reference.create-account "1" "OZKddff7510ffee60954ed179932439958d1359ba6eff6fab5ecefd208df8cf43701ee7dc8c2f7cd09cc87825f77a8ea057319c1efcec92f64e8be2387d59379d34" (read-keyset "user1"))
(test-capability (poly-fungible-reference.CREDIT "1" "OZKddff7510ffee60954ed179932439958d1359ba6eff6fab5ecefd208df8cf43701ee7dc8c2f7cd09cc87825f77a8ea057319c1efcec92f64e8be2387d59379d34"))
(poly-fungible-reference.credit "1" "OZKddff7510ffee60954ed179932439958d1359ba6eff6fab5ecefd208df8cf43701ee7dc8c2f7cd09cc87825f77a8ea057319c1efcec92f64e8be2387d59379d34" (read-keyset "user1") 100.0)

; Setup Merkle Root
; As initial state, we are assuming the merkle tree has the following roots already inserted

(free.merkle.insert-root "0" 9634049270485623739522952278040765597599123811671707163189917519424521430627)

; --------------------------------------------------------
; [✗] Deposit Transaction (coin) | Invalid public amount
; --------------------------------------------------------

(env-gasmodel "table")
(env-gaslimit 10000000)
(env-gas 0)

(env-data { 
    "token-instance": {"refName": {"name": "coin"},
                       "refSpec": [{"name": "fungible-v2"}]},
    "recipient-guard": {}
})

(expect-failure "fungible - deposit" "Invalid public amount" (test.opact.transact {
    "public_values":[9634049270485623739522952278040765597599123811671707163189917519424521430627 21443572485391568159800782191812935835534334817699172242223315142338162256601 4269983123749734087340863410786988242831943576810492558288143918332007368943 6250154787840353350922368577567451549626086440710487070480985801649216763244 12973498529895528841357449857067896740778377304443808515519232933800937283664 16768852531924857013319233799278541472304671946104081319805955428966186195608 13888677220227962285664607641729914664378206451716621336834392294603475737022 21414792165107094930503066755869007218485843369153027361954450892852833682115 10000000000000 19008814558092846015329179347507921612538374877486845078133601374546666165621],
    "a":{"x": 10058150586437843421650730904424051900338990434800132508300590266559781969208, "y": 12060224241606888197632270738692982527946635782137844917299504167392357454904 },
    "b":{"x":[11976227435144011517945955405558823388407115247215723266525760425528087239431 4439252845693994089886610845293600457590176571764381502449300422217212924896],"y":[14504775324758750444802879280091144430387585945725482650771520836937194770319 9690577804582453332179654047256202632829052703460549481040993204215278286442]},
    "c":{"x":7290687456311232397082418700335835970458993736518772473278005856027608329697,"y":4188508661923614223195539050205891218097748297891572332869999439412573600739}
  } {
    ; any change in tokenAmount will result in a different public amount, causing the transaction to fail
    ; i will change tokenAmount to 9000000000000 to simulate a different public amount

    "sender":"k:aaecdc57dd287ab576f48f7357f470fd41e0060e83197df1fe86c6866698c221",
    "recipient":"k:aaecdc57dd287ab576f48f7357f470fd41e0060e83197df1fe86c6866698c221",
    "tokenType": "fungible-v2",
    "tokenAmount":9000000000000,
    "tokenId": "0",
    "outputCommitments": [16768852531924857013319233799278541472304671946104081319805955428966186195608 13888677220227962285664607641729914664378206451716621336834392294603475737022],
    "encryptedReceipts": [""],
    "encryptedCommitments": ["eyJ2ZXJzaW9uIjoieDI1NTE5LXhzYWxzYTIwLXBvbHkxMzA1Iiwibm9uY2UiOiJjblo5NXZjQ3BDeDN0dWhYeTdpeG4rUjJDdWd6MUZJUCIsImVwaGVtUHVibGljS2V5IjoiTGk0TVNONEozTzMwQVUrYVBQMGp6WnFVbEFtVlRnNVZDd2J2Q2t0R28zRT0iLCJjaXBoZXJ0ZXh0IjoiSFYxdjlxUnNnZXdaYU9jajJQb2lndm55Y1B1UG9ZSEczc2ZCK1BSeTNHblpjMlZtVnhWcDZYcXJ3VENUOENTRVN6WWpGcmpCLzVMMkpzeUNvLzU1eEowVDlGTWhOcXYwOTBZOE9MSzRIRmpodzh5a3JTTm1wUVRqOTdiWWM4dXpCWHdFUk0zemhWUTRhaUZIOHdJdy9hMERsOENuNjBJNUY0bkpTWDh0d0ZKQTdjZ2MrZkh4NmppUWxLVHhhbDRya2djU0h0Z09XaDA1cjczeXJ4L3ZDMVdXSER6Z1BoNEdzZ2Z4cFUyNmRKYXExTFhaRmx2dDZKbERMSzNPRGQvZUFMaTd4YXgyb2xuQWVxcHc0MXVIYWlDRE9QSFRwZDhPcWFWdVdjb3Vjc0RHY1V4VGI4dUpWVkxUa1REY1JGaEFBSk5tbHB0UjVteGQxY2JsQ255VUJQbmhzTFNPenZIMTFsZ0NGdGRpdUliKy9uZkt1UHZMYnFETWpTTFRFTlREWmJ1ZVJONjJXOHNVRWtkM2hxRVFlZEMxSG1MeDdZNmJqQklEaGVIbjFnK2J1NXB3Sk5mWTUxOE92a0x6TmMxT3JoL2ZBL0ZUdGJiS3Z5SDZNMnVyeklNRDBFYkQ3TVRHdzBpbkIyZStnWk0vZFg3MGh3K05KNUQ5cU1mMWNKVG8vNktIS0llTUFWRmtjVEd1M2wvWlpoNU9HcEsvQUgzYXJxUTFyNVo5azBlYkFFY0oySUQ5R0dIUlhleHR6SzVFWHhGVmVDcm43ekM4L1VlcWZjdGIzNGxJTVJQQkwyQk92eU5aRDBqZEhCbHpncEJKSmtYck1QcHVxVVJCT1VlRnRqYUxuSVptWmp1NWN0OVRyU3kyNGJjOFM1azR2bENsRWFxT3p2R3pBZXRkYmpKWkQ2dFBqb3AvTCsxanFDRWhMd0dCS0pCTWRKbTFGNGN3UVh1VXc3R0Y2SVpNb2E0OWhzSDdMYmtHZ2pTS1hTVk5DZU8wV3ppM0hhTWwxSjVmSVBBS2QwZmV3R2pKZ3V6eFBjQWp1cjJKKzhHc2NkMDRLSGI0T2psUFFPSi9MZGZZbmo0Szkzek1kMDZMWU10MTh6SldSK0l2b3NWamZYcVM2dGtiWXg3WllySzlXQTZqcDloblA1WnpKWmhneTkweXoyT1ppRTFCSG9lSkpRS0MxcDNuT3RkN1pxM0tWbk5lKzJraGxaOWVlOE5CTGtBWGMvbXg4MUpIRmdRTzRBV05kT2d6aWZWOVBWU0k4VThtNmdFK0dMUlRmR2lDWmdUWk14NTE5anhUVlV5K0Q1amJSZz09In0=" "eyJ2ZXJzaW9uIjoieDI1NTE5LXhzYWxzYTIwLXBvbHkxMzA1Iiwibm9uY2UiOiJXRmVEekJyV1lIVHRwZXVmUStOSm1rRnpTdWZqN0dBRyIsImVwaGVtUHVibGljS2V5IjoiMGJKcklxbnpKYXFOSHRHZWkvNFlsekxsMEtEV2Y5WDJWVFZ5MnphQWRBUT0iLCJjaXBoZXJ0ZXh0IjoiVU45NWhiNWMrMTR5ZUhkbU1Sa3AxcTZ4bWIrZndZQkxWY1l0WXEyRmF5MlBXRndkRWVqRHFWbFJ1VTJ5TDcvaC8yL3BnelZtMDV2ZDBmeUxwUmFZQzNEUFFab3NaSlJranNta2d5eExPMDBxQnZwaFd5a1NiMzc3WUduRDNoSFFwRW5HMDJuNUtMdzBkZW03SE5XR1RwczI4RGhUYktaN1NrRFArWjlsbXJyTk9DSnYwaDN2NjBXYkZvT3hoSnJxOTJXM3RVQ0NBZ1JEMHBZbWsvWUJKcFV5T1Bod05YMm1Ham1hay94VHhhODJpaTFsaWpQaGcxZXdLaWExbGg0djdBMExjSnNWandaS0ZtVm42T3FYUW52VnR4a3NucVdZYnpURTNSYXdnc2VLSm0raDlXNGVJSzJ5S29vYnBUVU1VNC9ndCt0YlBzNVlUS2JSaFJPcGQ3QjIzbHpBR2VydmMwKzNrYTFjaVBSR21yMzZ4V09ic2xob0UwRmlzY0JKb2NGRWphMEVEQ1cxWndUYkhiWnZTSUNqS1F0aGtTSlEzL0ZyN1p2dTloaWxpTkhMN3JmLzEraXQ5dC91bzFtcXhOb2NqZE9ZNDZhYXE4ZjQ0UjZyWlJJZHN4WTFlUFRKbVFSUUhHR3JYazBINGdXTisrMjBmeldTWDVPaEhDMTd1Sms5Y3BaZG1OY0FmaVM4RWZDODRRMTc5L04vRSsxNW8zdGtPdFlMWGhhd2JrbGd6STlpaXNzPSJ9"]
  }))

(print {"Total gas": (env-gas)})

; --------------------------------------------------------
; [✗] Deposit Transaction (coin) | Invalid message hash
; --------------------------------------------------------

(env-gasmodel "table")
(env-gaslimit 10000000)
(env-gas 0)

(env-data { 
    "token-instance": {"refName": {"name": "coin"},
                       "refSpec": [{"name": "fungible-v2"}]},
    "recipient-guard": {}
})

(expect-failure "fungible - deposit" "Invalid message hash" (test.opact.transact {
    "public_values":[9634049270485623739522952278040765597599123811671707163189917519424521430627 21443572485391568159800782191812935835534334817699172242223315142338162256601 4269983123749734087340863410786988242831943576810492558288143918332007368943 6250154787840353350922368577567451549626086440710487070480985801649216763244 12973498529895528841357449857067896740778377304443808515519232933800937283664 16768852531924857013319233799278541472304671946104081319805955428966186195608 13888677220227962285664607641729914664378206451716621336834392294603475737022 21414792165107094930503066755869007218485843369153027361954450892852833682115 10000000000000 19008814558092846015329179347507921612538374877486845078133601374546666165621],
    "a":{"x": 10058150586437843421650730904424051900338990434800132508300590266559781969208, "y": 12060224241606888197632270738692982527946635782137844917299504167392357454904 },
    "b":{"x":[11976227435144011517945955405558823388407115247215723266525760425528087239431 4439252845693994089886610845293600457590176571764381502449300422217212924896],"y":[14504775324758750444802879280091144430387585945725482650771520836937194770319 9690577804582453332179654047256202632829052703460549481040993204215278286442]},
    "c":{"x":7290687456311232397082418700335835970458993736518772473278005856027608329697,"y":4188508661923614223195539050205891218097748297891572332869999439412573600739}
  } { 
    ; any change in this object will result in a different message hash, causing the transaction to fail
    ; i will change tokenType to "fungible-v3" to simulate a different message hash

    "sender":"k:aaecdc57dd287ab576f48f7357f470fd41e0060e83197df1fe86c6866698c221",
    "recipient":"k:aaecdc57dd287ab576f48f7357f470fd41e0060e83197df1fe86c6866698c221",
    "tokenType": "fungible-v3",
    "tokenAmount":10000000000000,
    "tokenId": "0",
    "outputCommitments": [16768852531924857013319233799278541472304671946104081319805955428966186195608 13888677220227962285664607641729914664378206451716621336834392294603475737022],
    "encryptedReceipts": [""],
    "encryptedCommitments": ["eyJ2ZXJzaW9uIjoieDI1NTE5LXhzYWxzYTIwLXBvbHkxMzA1Iiwibm9uY2UiOiJjblo5NXZjQ3BDeDN0dWhYeTdpeG4rUjJDdWd6MUZJUCIsImVwaGVtUHVibGljS2V5IjoiTGk0TVNONEozTzMwQVUrYVBQMGp6WnFVbEFtVlRnNVZDd2J2Q2t0R28zRT0iLCJjaXBoZXJ0ZXh0IjoiSFYxdjlxUnNnZXdaYU9jajJQb2lndm55Y1B1UG9ZSEczc2ZCK1BSeTNHblpjMlZtVnhWcDZYcXJ3VENUOENTRVN6WWpGcmpCLzVMMkpzeUNvLzU1eEowVDlGTWhOcXYwOTBZOE9MSzRIRmpodzh5a3JTTm1wUVRqOTdiWWM4dXpCWHdFUk0zemhWUTRhaUZIOHdJdy9hMERsOENuNjBJNUY0bkpTWDh0d0ZKQTdjZ2MrZkh4NmppUWxLVHhhbDRya2djU0h0Z09XaDA1cjczeXJ4L3ZDMVdXSER6Z1BoNEdzZ2Z4cFUyNmRKYXExTFhaRmx2dDZKbERMSzNPRGQvZUFMaTd4YXgyb2xuQWVxcHc0MXVIYWlDRE9QSFRwZDhPcWFWdVdjb3Vjc0RHY1V4VGI4dUpWVkxUa1REY1JGaEFBSk5tbHB0UjVteGQxY2JsQ255VUJQbmhzTFNPenZIMTFsZ0NGdGRpdUliKy9uZkt1UHZMYnFETWpTTFRFTlREWmJ1ZVJONjJXOHNVRWtkM2hxRVFlZEMxSG1MeDdZNmJqQklEaGVIbjFnK2J1NXB3Sk5mWTUxOE92a0x6TmMxT3JoL2ZBL0ZUdGJiS3Z5SDZNMnVyeklNRDBFYkQ3TVRHdzBpbkIyZStnWk0vZFg3MGh3K05KNUQ5cU1mMWNKVG8vNktIS0llTUFWRmtjVEd1M2wvWlpoNU9HcEsvQUgzYXJxUTFyNVo5azBlYkFFY0oySUQ5R0dIUlhleHR6SzVFWHhGVmVDcm43ekM4L1VlcWZjdGIzNGxJTVJQQkwyQk92eU5aRDBqZEhCbHpncEJKSmtYck1QcHVxVVJCT1VlRnRqYUxuSVptWmp1NWN0OVRyU3kyNGJjOFM1azR2bENsRWFxT3p2R3pBZXRkYmpKWkQ2dFBqb3AvTCsxanFDRWhMd0dCS0pCTWRKbTFGNGN3UVh1VXc3R0Y2SVpNb2E0OWhzSDdMYmtHZ2pTS1hTVk5DZU8wV3ppM0hhTWwxSjVmSVBBS2QwZmV3R2pKZ3V6eFBjQWp1cjJKKzhHc2NkMDRLSGI0T2psUFFPSi9MZGZZbmo0Szkzek1kMDZMWU10MTh6SldSK0l2b3NWamZYcVM2dGtiWXg3WllySzlXQTZqcDloblA1WnpKWmhneTkweXoyT1ppRTFCSG9lSkpRS0MxcDNuT3RkN1pxM0tWbk5lKzJraGxaOWVlOE5CTGtBWGMvbXg4MUpIRmdRTzRBV05kT2d6aWZWOVBWU0k4VThtNmdFK0dMUlRmR2lDWmdUWk14NTE5anhUVlV5K0Q1amJSZz09In0=" "eyJ2ZXJzaW9uIjoieDI1NTE5LXhzYWxzYTIwLXBvbHkxMzA1Iiwibm9uY2UiOiJXRmVEekJyV1lIVHRwZXVmUStOSm1rRnpTdWZqN0dBRyIsImVwaGVtUHVibGljS2V5IjoiMGJKcklxbnpKYXFOSHRHZWkvNFlsekxsMEtEV2Y5WDJWVFZ5MnphQWRBUT0iLCJjaXBoZXJ0ZXh0IjoiVU45NWhiNWMrMTR5ZUhkbU1Sa3AxcTZ4bWIrZndZQkxWY1l0WXEyRmF5MlBXRndkRWVqRHFWbFJ1VTJ5TDcvaC8yL3BnelZtMDV2ZDBmeUxwUmFZQzNEUFFab3NaSlJranNta2d5eExPMDBxQnZwaFd5a1NiMzc3WUduRDNoSFFwRW5HMDJuNUtMdzBkZW03SE5XR1RwczI4RGhUYktaN1NrRFArWjlsbXJyTk9DSnYwaDN2NjBXYkZvT3hoSnJxOTJXM3RVQ0NBZ1JEMHBZbWsvWUJKcFV5T1Bod05YMm1Ham1hay94VHhhODJpaTFsaWpQaGcxZXdLaWExbGg0djdBMExjSnNWandaS0ZtVm42T3FYUW52VnR4a3NucVdZYnpURTNSYXdnc2VLSm0raDlXNGVJSzJ5S29vYnBUVU1VNC9ndCt0YlBzNVlUS2JSaFJPcGQ3QjIzbHpBR2VydmMwKzNrYTFjaVBSR21yMzZ4V09ic2xob0UwRmlzY0JKb2NGRWphMEVEQ1cxWndUYkhiWnZTSUNqS1F0aGtTSlEzL0ZyN1p2dTloaWxpTkhMN3JmLzEraXQ5dC91bzFtcXhOb2NqZE9ZNDZhYXE4ZjQ0UjZyWlJJZHN4WTFlUFRKbVFSUUhHR3JYazBINGdXTisrMjBmeldTWDVPaEhDMTd1Sms5Y3BaZG1OY0FmaVM4RWZDODRRMTc5L04vRSsxNW8zdGtPdFlMWGhhd2JrbGd6STlpaXNzPSJ9"]
  }))


(print {"Total gas": (env-gas)})

; --------------------------------------------------------
; [✗] Deposit Transaction (coin) | Invalid token
; --------------------------------------------------------

(env-gasmodel "table")
(env-gaslimit 10000000)
(env-gas 0)

; any change in this object will result in a different token, causing the transaction to fail
; i will change refSpec to "poly-fungible-v2" and refName to poly-fungible-reference to simulate a different token

(env-data { 
    "token-instance": {"refName": {"name": "poly-fungible-reference","namespace": "test"},
    "refSpec": [{"name": "poly-fungible-v2","namespace": "kip"}]},
    "recipient-guard": {}
})

(expect-failure "fungible - deposit" "Invalid token" (test.opact.transact {
    "public_values":[9634049270485623739522952278040765597599123811671707163189917519424521430627 21443572485391568159800782191812935835534334817699172242223315142338162256601 4269983123749734087340863410786988242831943576810492558288143918332007368943 6250154787840353350922368577567451549626086440710487070480985801649216763244 12973498529895528841357449857067896740778377304443808515519232933800937283664 16768852531924857013319233799278541472304671946104081319805955428966186195608 13888677220227962285664607641729914664378206451716621336834392294603475737022 21414792165107094930503066755869007218485843369153027361954450892852833682115 10000000000000 19008814558092846015329179347507921612538374877486845078133601374546666165621],
    "a":{"x": 10058150586437843421650730904424051900338990434800132508300590266559781969208, "y": 12060224241606888197632270738692982527946635782137844917299504167392357454904 },
    "b":{"x":[11976227435144011517945955405558823388407115247215723266525760425528087239431 4439252845693994089886610845293600457590176571764381502449300422217212924896],"y":[14504775324758750444802879280091144430387585945725482650771520836937194770319 9690577804582453332179654047256202632829052703460549481040993204215278286442]},
    "c":{"x":7290687456311232397082418700335835970458993736518772473278005856027608329697,"y":4188508661923614223195539050205891218097748297891572332869999439412573600739}
  } { 
    "sender":"k:aaecdc57dd287ab576f48f7357f470fd41e0060e83197df1fe86c6866698c221",
    "recipient":"k:aaecdc57dd287ab576f48f7357f470fd41e0060e83197df1fe86c6866698c221",
    "tokenType": "fungible-v2",
    "tokenAmount":10000000000000,
    "tokenId": "0",
    "outputCommitments": [16768852531924857013319233799278541472304671946104081319805955428966186195608 13888677220227962285664607641729914664378206451716621336834392294603475737022],
    "encryptedReceipts": [""],
    "encryptedCommitments": ["eyJ2ZXJzaW9uIjoieDI1NTE5LXhzYWxzYTIwLXBvbHkxMzA1Iiwibm9uY2UiOiJjblo5NXZjQ3BDeDN0dWhYeTdpeG4rUjJDdWd6MUZJUCIsImVwaGVtUHVibGljS2V5IjoiTGk0TVNONEozTzMwQVUrYVBQMGp6WnFVbEFtVlRnNVZDd2J2Q2t0R28zRT0iLCJjaXBoZXJ0ZXh0IjoiSFYxdjlxUnNnZXdaYU9jajJQb2lndm55Y1B1UG9ZSEczc2ZCK1BSeTNHblpjMlZtVnhWcDZYcXJ3VENUOENTRVN6WWpGcmpCLzVMMkpzeUNvLzU1eEowVDlGTWhOcXYwOTBZOE9MSzRIRmpodzh5a3JTTm1wUVRqOTdiWWM4dXpCWHdFUk0zemhWUTRhaUZIOHdJdy9hMERsOENuNjBJNUY0bkpTWDh0d0ZKQTdjZ2MrZkh4NmppUWxLVHhhbDRya2djU0h0Z09XaDA1cjczeXJ4L3ZDMVdXSER6Z1BoNEdzZ2Z4cFUyNmRKYXExTFhaRmx2dDZKbERMSzNPRGQvZUFMaTd4YXgyb2xuQWVxcHc0MXVIYWlDRE9QSFRwZDhPcWFWdVdjb3Vjc0RHY1V4VGI4dUpWVkxUa1REY1JGaEFBSk5tbHB0UjVteGQxY2JsQ255VUJQbmhzTFNPenZIMTFsZ0NGdGRpdUliKy9uZkt1UHZMYnFETWpTTFRFTlREWmJ1ZVJONjJXOHNVRWtkM2hxRVFlZEMxSG1MeDdZNmJqQklEaGVIbjFnK2J1NXB3Sk5mWTUxOE92a0x6TmMxT3JoL2ZBL0ZUdGJiS3Z5SDZNMnVyeklNRDBFYkQ3TVRHdzBpbkIyZStnWk0vZFg3MGh3K05KNUQ5cU1mMWNKVG8vNktIS0llTUFWRmtjVEd1M2wvWlpoNU9HcEsvQUgzYXJxUTFyNVo5azBlYkFFY0oySUQ5R0dIUlhleHR6SzVFWHhGVmVDcm43ekM4L1VlcWZjdGIzNGxJTVJQQkwyQk92eU5aRDBqZEhCbHpncEJKSmtYck1QcHVxVVJCT1VlRnRqYUxuSVptWmp1NWN0OVRyU3kyNGJjOFM1azR2bENsRWFxT3p2R3pBZXRkYmpKWkQ2dFBqb3AvTCsxanFDRWhMd0dCS0pCTWRKbTFGNGN3UVh1VXc3R0Y2SVpNb2E0OWhzSDdMYmtHZ2pTS1hTVk5DZU8wV3ppM0hhTWwxSjVmSVBBS2QwZmV3R2pKZ3V6eFBjQWp1cjJKKzhHc2NkMDRLSGI0T2psUFFPSi9MZGZZbmo0Szkzek1kMDZMWU10MTh6SldSK0l2b3NWamZYcVM2dGtiWXg3WllySzlXQTZqcDloblA1WnpKWmhneTkweXoyT1ppRTFCSG9lSkpRS0MxcDNuT3RkN1pxM0tWbk5lKzJraGxaOWVlOE5CTGtBWGMvbXg4MUpIRmdRTzRBV05kT2d6aWZWOVBWU0k4VThtNmdFK0dMUlRmR2lDWmdUWk14NTE5anhUVlV5K0Q1amJSZz09In0=" "eyJ2ZXJzaW9uIjoieDI1NTE5LXhzYWxzYTIwLXBvbHkxMzA1Iiwibm9uY2UiOiJXRmVEekJyV1lIVHRwZXVmUStOSm1rRnpTdWZqN0dBRyIsImVwaGVtUHVibGljS2V5IjoiMGJKcklxbnpKYXFOSHRHZWkvNFlsekxsMEtEV2Y5WDJWVFZ5MnphQWRBUT0iLCJjaXBoZXJ0ZXh0IjoiVU45NWhiNWMrMTR5ZUhkbU1Sa3AxcTZ4bWIrZndZQkxWY1l0WXEyRmF5MlBXRndkRWVqRHFWbFJ1VTJ5TDcvaC8yL3BnelZtMDV2ZDBmeUxwUmFZQzNEUFFab3NaSlJranNta2d5eExPMDBxQnZwaFd5a1NiMzc3WUduRDNoSFFwRW5HMDJuNUtMdzBkZW03SE5XR1RwczI4RGhUYktaN1NrRFArWjlsbXJyTk9DSnYwaDN2NjBXYkZvT3hoSnJxOTJXM3RVQ0NBZ1JEMHBZbWsvWUJKcFV5T1Bod05YMm1Ham1hay94VHhhODJpaTFsaWpQaGcxZXdLaWExbGg0djdBMExjSnNWandaS0ZtVm42T3FYUW52VnR4a3NucVdZYnpURTNSYXdnc2VLSm0raDlXNGVJSzJ5S29vYnBUVU1VNC9ndCt0YlBzNVlUS2JSaFJPcGQ3QjIzbHpBR2VydmMwKzNrYTFjaVBSR21yMzZ4V09ic2xob0UwRmlzY0JKb2NGRWphMEVEQ1cxWndUYkhiWnZTSUNqS1F0aGtTSlEzL0ZyN1p2dTloaWxpTkhMN3JmLzEraXQ5dC91bzFtcXhOb2NqZE9ZNDZhYXE4ZjQ0UjZyWlJJZHN4WTFlUFRKbVFSUUhHR3JYazBINGdXTisrMjBmeldTWDVPaEhDMTd1Sms5Y3BaZG1OY0FmaVM4RWZDODRRMTc5L04vRSsxNW8zdGtPdFlMWGhhd2JrbGd6STlpaXNzPSJ9"]
  }))

(print {"Total gas": (env-gas)})

; --------------------------------------------------------
; [✗] Deposit Transaction (coin) | Amount is larger than maximum deposit amount
; --------------------------------------------------------

(test-capability (coin.TRANSFER "k:aaecdc57dd287ab576f48f7357f470fd41e0060e83197df1fe86c6866698c221" "opact-contract" 10.0))

(env-gasmodel "table")
(env-gaslimit 10000000)
(env-gas 0)

; i will change the configure limits to 9.0 to simulate a maximum accepted deposit amount of 9.0
; this will cause the transaction to fail because the amount to be deposited is 10.0

(env-data { 
  "token-instance": {"refName": {"name": "coin"},
                     "refSpec": [{"name": "fungible-v2"}]},
  "recipient-guard": {}
})

(test.opact.configure-limits 9.0)

(expect-failure "fungible - deposit" "amount is larger than maximumDepositAmount" (test.opact.transact {
    "public_values":[9634049270485623739522952278040765597599123811671707163189917519424521430627 21443572485391568159800782191812935835534334817699172242223315142338162256601 4269983123749734087340863410786988242831943576810492558288143918332007368943 6250154787840353350922368577567451549626086440710487070480985801649216763244 12973498529895528841357449857067896740778377304443808515519232933800937283664 16768852531924857013319233799278541472304671946104081319805955428966186195608 13888677220227962285664607641729914664378206451716621336834392294603475737022 21414792165107094930503066755869007218485843369153027361954450892852833682115 10000000000000 19008814558092846015329179347507921612538374877486845078133601374546666165621],
    "a":{"x": 10058150586437843421650730904424051900338990434800132508300590266559781969208, "y": 12060224241606888197632270738692982527946635782137844917299504167392357454904 },
    "b":{"x":[11976227435144011517945955405558823388407115247215723266525760425528087239431 4439252845693994089886610845293600457590176571764381502449300422217212924896],"y":[14504775324758750444802879280091144430387585945725482650771520836937194770319 9690577804582453332179654047256202632829052703460549481040993204215278286442]},
    "c":{"x":7290687456311232397082418700335835970458993736518772473278005856027608329697,"y":4188508661923614223195539050205891218097748297891572332869999439412573600739}
  } { 
    "sender":"k:aaecdc57dd287ab576f48f7357f470fd41e0060e83197df1fe86c6866698c221",
    "recipient":"k:aaecdc57dd287ab576f48f7357f470fd41e0060e83197df1fe86c6866698c221",
    "tokenType": "fungible-v2",
    "tokenAmount":10000000000000,
    "tokenId": "0",
    "outputCommitments": [16768852531924857013319233799278541472304671946104081319805955428966186195608 13888677220227962285664607641729914664378206451716621336834392294603475737022],
    "encryptedReceipts": [""],
    "encryptedCommitments": ["eyJ2ZXJzaW9uIjoieDI1NTE5LXhzYWxzYTIwLXBvbHkxMzA1Iiwibm9uY2UiOiJjblo5NXZjQ3BDeDN0dWhYeTdpeG4rUjJDdWd6MUZJUCIsImVwaGVtUHVibGljS2V5IjoiTGk0TVNONEozTzMwQVUrYVBQMGp6WnFVbEFtVlRnNVZDd2J2Q2t0R28zRT0iLCJjaXBoZXJ0ZXh0IjoiSFYxdjlxUnNnZXdaYU9jajJQb2lndm55Y1B1UG9ZSEczc2ZCK1BSeTNHblpjMlZtVnhWcDZYcXJ3VENUOENTRVN6WWpGcmpCLzVMMkpzeUNvLzU1eEowVDlGTWhOcXYwOTBZOE9MSzRIRmpodzh5a3JTTm1wUVRqOTdiWWM4dXpCWHdFUk0zemhWUTRhaUZIOHdJdy9hMERsOENuNjBJNUY0bkpTWDh0d0ZKQTdjZ2MrZkh4NmppUWxLVHhhbDRya2djU0h0Z09XaDA1cjczeXJ4L3ZDMVdXSER6Z1BoNEdzZ2Z4cFUyNmRKYXExTFhaRmx2dDZKbERMSzNPRGQvZUFMaTd4YXgyb2xuQWVxcHc0MXVIYWlDRE9QSFRwZDhPcWFWdVdjb3Vjc0RHY1V4VGI4dUpWVkxUa1REY1JGaEFBSk5tbHB0UjVteGQxY2JsQ255VUJQbmhzTFNPenZIMTFsZ0NGdGRpdUliKy9uZkt1UHZMYnFETWpTTFRFTlREWmJ1ZVJONjJXOHNVRWtkM2hxRVFlZEMxSG1MeDdZNmJqQklEaGVIbjFnK2J1NXB3Sk5mWTUxOE92a0x6TmMxT3JoL2ZBL0ZUdGJiS3Z5SDZNMnVyeklNRDBFYkQ3TVRHdzBpbkIyZStnWk0vZFg3MGh3K05KNUQ5cU1mMWNKVG8vNktIS0llTUFWRmtjVEd1M2wvWlpoNU9HcEsvQUgzYXJxUTFyNVo5azBlYkFFY0oySUQ5R0dIUlhleHR6SzVFWHhGVmVDcm43ekM4L1VlcWZjdGIzNGxJTVJQQkwyQk92eU5aRDBqZEhCbHpncEJKSmtYck1QcHVxVVJCT1VlRnRqYUxuSVptWmp1NWN0OVRyU3kyNGJjOFM1azR2bENsRWFxT3p2R3pBZXRkYmpKWkQ2dFBqb3AvTCsxanFDRWhMd0dCS0pCTWRKbTFGNGN3UVh1VXc3R0Y2SVpNb2E0OWhzSDdMYmtHZ2pTS1hTVk5DZU8wV3ppM0hhTWwxSjVmSVBBS2QwZmV3R2pKZ3V6eFBjQWp1cjJKKzhHc2NkMDRLSGI0T2psUFFPSi9MZGZZbmo0Szkzek1kMDZMWU10MTh6SldSK0l2b3NWamZYcVM2dGtiWXg3WllySzlXQTZqcDloblA1WnpKWmhneTkweXoyT1ppRTFCSG9lSkpRS0MxcDNuT3RkN1pxM0tWbk5lKzJraGxaOWVlOE5CTGtBWGMvbXg4MUpIRmdRTzRBV05kT2d6aWZWOVBWU0k4VThtNmdFK0dMUlRmR2lDWmdUWk14NTE5anhUVlV5K0Q1amJSZz09In0=" "eyJ2ZXJzaW9uIjoieDI1NTE5LXhzYWxzYTIwLXBvbHkxMzA1Iiwibm9uY2UiOiJXRmVEekJyV1lIVHRwZXVmUStOSm1rRnpTdWZqN0dBRyIsImVwaGVtUHVibGljS2V5IjoiMGJKcklxbnpKYXFOSHRHZWkvNFlsekxsMEtEV2Y5WDJWVFZ5MnphQWRBUT0iLCJjaXBoZXJ0ZXh0IjoiVU45NWhiNWMrMTR5ZUhkbU1Sa3AxcTZ4bWIrZndZQkxWY1l0WXEyRmF5MlBXRndkRWVqRHFWbFJ1VTJ5TDcvaC8yL3BnelZtMDV2ZDBmeUxwUmFZQzNEUFFab3NaSlJranNta2d5eExPMDBxQnZwaFd5a1NiMzc3WUduRDNoSFFwRW5HMDJuNUtMdzBkZW03SE5XR1RwczI4RGhUYktaN1NrRFArWjlsbXJyTk9DSnYwaDN2NjBXYkZvT3hoSnJxOTJXM3RVQ0NBZ1JEMHBZbWsvWUJKcFV5T1Bod05YMm1Ham1hay94VHhhODJpaTFsaWpQaGcxZXdLaWExbGg0djdBMExjSnNWandaS0ZtVm42T3FYUW52VnR4a3NucVdZYnpURTNSYXdnc2VLSm0raDlXNGVJSzJ5S29vYnBUVU1VNC9ndCt0YlBzNVlUS2JSaFJPcGQ3QjIzbHpBR2VydmMwKzNrYTFjaVBSR21yMzZ4V09ic2xob0UwRmlzY0JKb2NGRWphMEVEQ1cxWndUYkhiWnZTSUNqS1F0aGtTSlEzL0ZyN1p2dTloaWxpTkhMN3JmLzEraXQ5dC91bzFtcXhOb2NqZE9ZNDZhYXE4ZjQ0UjZyWlJJZHN4WTFlUFRKbVFSUUhHR3JYazBINGdXTisrMjBmeldTWDVPaEhDMTd1Sms5Y3BaZG1OY0FmaVM4RWZDODRRMTc5L04vRSsxNW8zdGtPdFlMWGhhd2JrbGd6STlpaXNzPSJ9"]
  }))

(print {"Total gas": (env-gas)})

; --------------------------------------------------------
; [✗] Deposit Transaction (coin) | Invalid merkle root
; --------------------------------------------------------

(env-gasmodel "table")
(env-gaslimit 10000000)
(env-gas 0)

; i will change the first value in the public values array to simulate a different merkle root
; from 9634049270485623739522952278040765597599123811671707163189917519424521430627
; to 9634049270485623739522952278040765597599123811671707163189917519424521430628

(env-data { 
  "token-instance": {"refName": {"name": "coin"},
                     "refSpec": [{"name": "fungible-v2"}]},
  "recipient-guard": {}
})

(test.opact.configure-limits 1000000000000.0)

(expect-failure "fungible - deposit" "Invalid merkle root" (test.opact.transact {
    "public_values":[9634049270485623739522952278040765597599123811671707163189917519424521430628 21443572485391568159800782191812935835534334817699172242223315142338162256601 4269983123749734087340863410786988242831943576810492558288143918332007368943 6250154787840353350922368577567451549626086440710487070480985801649216763244 12973498529895528841357449857067896740778377304443808515519232933800937283664 16768852531924857013319233799278541472304671946104081319805955428966186195608 13888677220227962285664607641729914664378206451716621336834392294603475737022 21414792165107094930503066755869007218485843369153027361954450892852833682115 10000000000000 19008814558092846015329179347507921612538374877486845078133601374546666165621],
    "a":{"x": 10058150586437843421650730904424051900338990434800132508300590266559781969208, "y": 12060224241606888197632270738692982527946635782137844917299504167392357454904 },
    "b":{"x":[11976227435144011517945955405558823388407115247215723266525760425528087239431 4439252845693994089886610845293600457590176571764381502449300422217212924896],"y":[14504775324758750444802879280091144430387585945725482650771520836937194770319 9690577804582453332179654047256202632829052703460549481040993204215278286442]},
    "c":{"x":7290687456311232397082418700335835970458993736518772473278005856027608329697,"y":4188508661923614223195539050205891218097748297891572332869999439412573600739}
  } { 
    "sender":"k:aaecdc57dd287ab576f48f7357f470fd41e0060e83197df1fe86c6866698c221",
    "recipient":"k:aaecdc57dd287ab576f48f7357f470fd41e0060e83197df1fe86c6866698c221",
    "tokenType": "fungible-v2",
    "tokenAmount":10000000000000,
    "tokenId": "0",
    "outputCommitments": [16768852531924857013319233799278541472304671946104081319805955428966186195608 13888677220227962285664607641729914664378206451716621336834392294603475737022],
    "encryptedReceipts": [""],
    "encryptedCommitments": ["eyJ2ZXJzaW9uIjoieDI1NTE5LXhzYWxzYTIwLXBvbHkxMzA1Iiwibm9uY2UiOiJjblo5NXZjQ3BDeDN0dWhYeTdpeG4rUjJDdWd6MUZJUCIsImVwaGVtUHVibGljS2V5IjoiTGk0TVNONEozTzMwQVUrYVBQMGp6WnFVbEFtVlRnNVZDd2J2Q2t0R28zRT0iLCJjaXBoZXJ0ZXh0IjoiSFYxdjlxUnNnZXdaYU9jajJQb2lndm55Y1B1UG9ZSEczc2ZCK1BSeTNHblpjMlZtVnhWcDZYcXJ3VENUOENTRVN6WWpGcmpCLzVMMkpzeUNvLzU1eEowVDlGTWhOcXYwOTBZOE9MSzRIRmpodzh5a3JTTm1wUVRqOTdiWWM4dXpCWHdFUk0zemhWUTRhaUZIOHdJdy9hMERsOENuNjBJNUY0bkpTWDh0d0ZKQTdjZ2MrZkh4NmppUWxLVHhhbDRya2djU0h0Z09XaDA1cjczeXJ4L3ZDMVdXSER6Z1BoNEdzZ2Z4cFUyNmRKYXExTFhaRmx2dDZKbERMSzNPRGQvZUFMaTd4YXgyb2xuQWVxcHc0MXVIYWlDRE9QSFRwZDhPcWFWdVdjb3Vjc0RHY1V4VGI4dUpWVkxUa1REY1JGaEFBSk5tbHB0UjVteGQxY2JsQ255VUJQbmhzTFNPenZIMTFsZ0NGdGRpdUliKy9uZkt1UHZMYnFETWpTTFRFTlREWmJ1ZVJONjJXOHNVRWtkM2hxRVFlZEMxSG1MeDdZNmJqQklEaGVIbjFnK2J1NXB3Sk5mWTUxOE92a0x6TmMxT3JoL2ZBL0ZUdGJiS3Z5SDZNMnVyeklNRDBFYkQ3TVRHdzBpbkIyZStnWk0vZFg3MGh3K05KNUQ5cU1mMWNKVG8vNktIS0llTUFWRmtjVEd1M2wvWlpoNU9HcEsvQUgzYXJxUTFyNVo5azBlYkFFY0oySUQ5R0dIUlhleHR6SzVFWHhGVmVDcm43ekM4L1VlcWZjdGIzNGxJTVJQQkwyQk92eU5aRDBqZEhCbHpncEJKSmtYck1QcHVxVVJCT1VlRnRqYUxuSVptWmp1NWN0OVRyU3kyNGJjOFM1azR2bENsRWFxT3p2R3pBZXRkYmpKWkQ2dFBqb3AvTCsxanFDRWhMd0dCS0pCTWRKbTFGNGN3UVh1VXc3R0Y2SVpNb2E0OWhzSDdMYmtHZ2pTS1hTVk5DZU8wV3ppM0hhTWwxSjVmSVBBS2QwZmV3R2pKZ3V6eFBjQWp1cjJKKzhHc2NkMDRLSGI0T2psUFFPSi9MZGZZbmo0Szkzek1kMDZMWU10MTh6SldSK0l2b3NWamZYcVM2dGtiWXg3WllySzlXQTZqcDloblA1WnpKWmhneTkweXoyT1ppRTFCSG9lSkpRS0MxcDNuT3RkN1pxM0tWbk5lKzJraGxaOWVlOE5CTGtBWGMvbXg4MUpIRmdRTzRBV05kT2d6aWZWOVBWU0k4VThtNmdFK0dMUlRmR2lDWmdUWk14NTE5anhUVlV5K0Q1amJSZz09In0=" "eyJ2ZXJzaW9uIjoieDI1NTE5LXhzYWxzYTIwLXBvbHkxMzA1Iiwibm9uY2UiOiJXRmVEekJyV1lIVHRwZXVmUStOSm1rRnpTdWZqN0dBRyIsImVwaGVtUHVibGljS2V5IjoiMGJKcklxbnpKYXFOSHRHZWkvNFlsekxsMEtEV2Y5WDJWVFZ5MnphQWRBUT0iLCJjaXBoZXJ0ZXh0IjoiVU45NWhiNWMrMTR5ZUhkbU1Sa3AxcTZ4bWIrZndZQkxWY1l0WXEyRmF5MlBXRndkRWVqRHFWbFJ1VTJ5TDcvaC8yL3BnelZtMDV2ZDBmeUxwUmFZQzNEUFFab3NaSlJranNta2d5eExPMDBxQnZwaFd5a1NiMzc3WUduRDNoSFFwRW5HMDJuNUtMdzBkZW03SE5XR1RwczI4RGhUYktaN1NrRFArWjlsbXJyTk9DSnYwaDN2NjBXYkZvT3hoSnJxOTJXM3RVQ0NBZ1JEMHBZbWsvWUJKcFV5T1Bod05YMm1Ham1hay94VHhhODJpaTFsaWpQaGcxZXdLaWExbGg0djdBMExjSnNWandaS0ZtVm42T3FYUW52VnR4a3NucVdZYnpURTNSYXdnc2VLSm0raDlXNGVJSzJ5S29vYnBUVU1VNC9ndCt0YlBzNVlUS2JSaFJPcGQ3QjIzbHpBR2VydmMwKzNrYTFjaVBSR21yMzZ4V09ic2xob0UwRmlzY0JKb2NGRWphMEVEQ1cxWndUYkhiWnZTSUNqS1F0aGtTSlEzL0ZyN1p2dTloaWxpTkhMN3JmLzEraXQ5dC91bzFtcXhOb2NqZE9ZNDZhYXE4ZjQ0UjZyWlJJZHN4WTFlUFRKbVFSUUhHR3JYazBINGdXTisrMjBmeldTWDVPaEhDMTd1Sms5Y3BaZG1OY0FmaVM4RWZDODRRMTc5L04vRSsxNW8zdGtPdFlMWGhhd2JrbGd6STlpaXNzPSJ9"]
  }))

(print {"Total gas": (env-gas)})

; --------------------------------------------------------
; [✔] Deposit Transaction (coin) | Successful
; --------------------------------------------------------

(test-capability (coin.TRANSFER "k:aaecdc57dd287ab576f48f7357f470fd41e0060e83197df1fe86c6866698c221" "opact-gas-payer" 2.0))

(env-gasmodel "table")
(env-gaslimit 10000000)
(env-gas 0)

(env-data { 
    "token-instance": {"refName": {"name": "coin"},
                       "refSpec": [{"name": "fungible-v2"}]},
    "recipient-guard": {}
})

(test.opact.transact {
    "public_values":[9634049270485623739522952278040765597599123811671707163189917519424521430627 21443572485391568159800782191812935835534334817699172242223315142338162256601 4269983123749734087340863410786988242831943576810492558288143918332007368943 6250154787840353350922368577567451549626086440710487070480985801649216763244 12973498529895528841357449857067896740778377304443808515519232933800937283664 16768852531924857013319233799278541472304671946104081319805955428966186195608 13888677220227962285664607641729914664378206451716621336834392294603475737022 21414792165107094930503066755869007218485843369153027361954450892852833682115 10000000000000 19008814558092846015329179347507921612538374877486845078133601374546666165621],
    "a":{"x": 10058150586437843421650730904424051900338990434800132508300590266559781969208, "y": 12060224241606888197632270738692982527946635782137844917299504167392357454904 },
    "b":{"x":[11976227435144011517945955405558823388407115247215723266525760425528087239431 4439252845693994089886610845293600457590176571764381502449300422217212924896],"y":[14504775324758750444802879280091144430387585945725482650771520836937194770319 9690577804582453332179654047256202632829052703460549481040993204215278286442]},
    "c":{"x":7290687456311232397082418700335835970458993736518772473278005856027608329697,"y":4188508661923614223195539050205891218097748297891572332869999439412573600739}
  } {
    "sender":"k:aaecdc57dd287ab576f48f7357f470fd41e0060e83197df1fe86c6866698c221",
    "recipient":"k:aaecdc57dd287ab576f48f7357f470fd41e0060e83197df1fe86c6866698c221",
    "tokenType": "fungible-v2",
    "tokenAmount":10000000000000,
    "tokenId": "0",
    "outputCommitments": [16768852531924857013319233799278541472304671946104081319805955428966186195608 13888677220227962285664607641729914664378206451716621336834392294603475737022],
    "encryptedReceipts": [""],
    "encryptedCommitments": ["eyJ2ZXJzaW9uIjoieDI1NTE5LXhzYWxzYTIwLXBvbHkxMzA1Iiwibm9uY2UiOiJjblo5NXZjQ3BDeDN0dWhYeTdpeG4rUjJDdWd6MUZJUCIsImVwaGVtUHVibGljS2V5IjoiTGk0TVNONEozTzMwQVUrYVBQMGp6WnFVbEFtVlRnNVZDd2J2Q2t0R28zRT0iLCJjaXBoZXJ0ZXh0IjoiSFYxdjlxUnNnZXdaYU9jajJQb2lndm55Y1B1UG9ZSEczc2ZCK1BSeTNHblpjMlZtVnhWcDZYcXJ3VENUOENTRVN6WWpGcmpCLzVMMkpzeUNvLzU1eEowVDlGTWhOcXYwOTBZOE9MSzRIRmpodzh5a3JTTm1wUVRqOTdiWWM4dXpCWHdFUk0zemhWUTRhaUZIOHdJdy9hMERsOENuNjBJNUY0bkpTWDh0d0ZKQTdjZ2MrZkh4NmppUWxLVHhhbDRya2djU0h0Z09XaDA1cjczeXJ4L3ZDMVdXSER6Z1BoNEdzZ2Z4cFUyNmRKYXExTFhaRmx2dDZKbERMSzNPRGQvZUFMaTd4YXgyb2xuQWVxcHc0MXVIYWlDRE9QSFRwZDhPcWFWdVdjb3Vjc0RHY1V4VGI4dUpWVkxUa1REY1JGaEFBSk5tbHB0UjVteGQxY2JsQ255VUJQbmhzTFNPenZIMTFsZ0NGdGRpdUliKy9uZkt1UHZMYnFETWpTTFRFTlREWmJ1ZVJONjJXOHNVRWtkM2hxRVFlZEMxSG1MeDdZNmJqQklEaGVIbjFnK2J1NXB3Sk5mWTUxOE92a0x6TmMxT3JoL2ZBL0ZUdGJiS3Z5SDZNMnVyeklNRDBFYkQ3TVRHdzBpbkIyZStnWk0vZFg3MGh3K05KNUQ5cU1mMWNKVG8vNktIS0llTUFWRmtjVEd1M2wvWlpoNU9HcEsvQUgzYXJxUTFyNVo5azBlYkFFY0oySUQ5R0dIUlhleHR6SzVFWHhGVmVDcm43ekM4L1VlcWZjdGIzNGxJTVJQQkwyQk92eU5aRDBqZEhCbHpncEJKSmtYck1QcHVxVVJCT1VlRnRqYUxuSVptWmp1NWN0OVRyU3kyNGJjOFM1azR2bENsRWFxT3p2R3pBZXRkYmpKWkQ2dFBqb3AvTCsxanFDRWhMd0dCS0pCTWRKbTFGNGN3UVh1VXc3R0Y2SVpNb2E0OWhzSDdMYmtHZ2pTS1hTVk5DZU8wV3ppM0hhTWwxSjVmSVBBS2QwZmV3R2pKZ3V6eFBjQWp1cjJKKzhHc2NkMDRLSGI0T2psUFFPSi9MZGZZbmo0Szkzek1kMDZMWU10MTh6SldSK0l2b3NWamZYcVM2dGtiWXg3WllySzlXQTZqcDloblA1WnpKWmhneTkweXoyT1ppRTFCSG9lSkpRS0MxcDNuT3RkN1pxM0tWbk5lKzJraGxaOWVlOE5CTGtBWGMvbXg4MUpIRmdRTzRBV05kT2d6aWZWOVBWU0k4VThtNmdFK0dMUlRmR2lDWmdUWk14NTE5anhUVlV5K0Q1amJSZz09In0=" "eyJ2ZXJzaW9uIjoieDI1NTE5LXhzYWxzYTIwLXBvbHkxMzA1Iiwibm9uY2UiOiJXRmVEekJyV1lIVHRwZXVmUStOSm1rRnpTdWZqN0dBRyIsImVwaGVtUHVibGljS2V5IjoiMGJKcklxbnpKYXFOSHRHZWkvNFlsekxsMEtEV2Y5WDJWVFZ5MnphQWRBUT0iLCJjaXBoZXJ0ZXh0IjoiVU45NWhiNWMrMTR5ZUhkbU1Sa3AxcTZ4bWIrZndZQkxWY1l0WXEyRmF5MlBXRndkRWVqRHFWbFJ1VTJ5TDcvaC8yL3BnelZtMDV2ZDBmeUxwUmFZQzNEUFFab3NaSlJranNta2d5eExPMDBxQnZwaFd5a1NiMzc3WUduRDNoSFFwRW5HMDJuNUtMdzBkZW03SE5XR1RwczI4RGhUYktaN1NrRFArWjlsbXJyTk9DSnYwaDN2NjBXYkZvT3hoSnJxOTJXM3RVQ0NBZ1JEMHBZbWsvWUJKcFV5T1Bod05YMm1Ham1hay94VHhhODJpaTFsaWpQaGcxZXdLaWExbGg0djdBMExjSnNWandaS0ZtVm42T3FYUW52VnR4a3NucVdZYnpURTNSYXdnc2VLSm0raDlXNGVJSzJ5S29vYnBUVU1VNC9ndCt0YlBzNVlUS2JSaFJPcGQ3QjIzbHpBR2VydmMwKzNrYTFjaVBSR21yMzZ4V09ic2xob0UwRmlzY0JKb2NGRWphMEVEQ1cxWndUYkhiWnZTSUNqS1F0aGtTSlEzL0ZyN1p2dTloaWxpTkhMN3JmLzEraXQ5dC91bzFtcXhOb2NqZE9ZNDZhYXE4ZjQ0UjZyWlJJZHN4WTFlUFRKbVFSUUhHR3JYazBINGdXTisrMjBmeldTWDVPaEhDMTd1Sms5Y3BaZG1OY0FmaVM4RWZDODRRMTc5L04vRSsxNW8zdGtPdFlMWGhhd2JrbGd6STlpaXNzPSJ9"]
  })

(print {"Total gas": (env-gas)})

(expect "fungible - deposit - sender balance (native)" 90.0 (coin.get-balance "k:aaecdc57dd287ab576f48f7357f470fd41e0060e83197df1fe86c6866698c221"))
(expect "fungible - deposit - contract balance (fungible)" 10.0 (coin.get-balance "opact-contract"))
(expect "fungible - deposit - gas payer balance (native)" 0.0 (coin.get-balance "opact-gas-payer"))

; --------------------------------------------------------
; [✗] Deposit Transaction (coin) | Input is already spent
; --------------------------------------------------------
; if i try to deposit the same amount again, the transaction will fail because the input is already spent
; all public values are nullified after a transaction is successfully, so the same public values cannot be used again to avoid replay attacks

(env-gasmodel "table")
(env-gaslimit 10000000)
(env-gas 0)

(env-data { 
    "token-instance": {"refName": {"name": "coin"},
                       "refSpec": [{"name": "fungible-v2"}]},
    "recipient-guard": {}
})

(test.opact.configure-limits 1000000000000.0)

(expect-failure "fungible - deposit" "Input is already spent" (test.opact.transact {
    "public_values":[9634049270485623739522952278040765597599123811671707163189917519424521430627 21443572485391568159800782191812935835534334817699172242223315142338162256601 4269983123749734087340863410786988242831943576810492558288143918332007368943 6250154787840353350922368577567451549626086440710487070480985801649216763244 12973498529895528841357449857067896740778377304443808515519232933800937283664 16768852531924857013319233799278541472304671946104081319805955428966186195608 13888677220227962285664607641729914664378206451716621336834392294603475737022 21414792165107094930503066755869007218485843369153027361954450892852833682115 10000000000000 19008814558092846015329179347507921612538374877486845078133601374546666165621],
    "a":{"x": 10058150586437843421650730904424051900338990434800132508300590266559781969208, "y": 12060224241606888197632270738692982527946635782137844917299504167392357454904 },
    "b":{"x":[11976227435144011517945955405558823388407115247215723266525760425528087239431 4439252845693994089886610845293600457590176571764381502449300422217212924896],"y":[14504775324758750444802879280091144430387585945725482650771520836937194770319 9690577804582453332179654047256202632829052703460549481040993204215278286442]},
    "c":{"x":7290687456311232397082418700335835970458993736518772473278005856027608329697,"y":4188508661923614223195539050205891218097748297891572332869999439412573600739}
  } {
    "sender":"k:aaecdc57dd287ab576f48f7357f470fd41e0060e83197df1fe86c6866698c221",
    "recipient":"k:aaecdc57dd287ab576f48f7357f470fd41e0060e83197df1fe86c6866698c221",
    "tokenType": "fungible-v2",
    "tokenAmount":10000000000000,
    "tokenId": "0",
    "outputCommitments": [16768852531924857013319233799278541472304671946104081319805955428966186195608 13888677220227962285664607641729914664378206451716621336834392294603475737022],
    "encryptedReceipts": [""],
    "encryptedCommitments": ["eyJ2ZXJzaW9uIjoieDI1NTE5LXhzYWxzYTIwLXBvbHkxMzA1Iiwibm9uY2UiOiJjblo5NXZjQ3BDeDN0dWhYeTdpeG4rUjJDdWd6MUZJUCIsImVwaGVtUHVibGljS2V5IjoiTGk0TVNONEozTzMwQVUrYVBQMGp6WnFVbEFtVlRnNVZDd2J2Q2t0R28zRT0iLCJjaXBoZXJ0ZXh0IjoiSFYxdjlxUnNnZXdaYU9jajJQb2lndm55Y1B1UG9ZSEczc2ZCK1BSeTNHblpjMlZtVnhWcDZYcXJ3VENUOENTRVN6WWpGcmpCLzVMMkpzeUNvLzU1eEowVDlGTWhOcXYwOTBZOE9MSzRIRmpodzh5a3JTTm1wUVRqOTdiWWM4dXpCWHdFUk0zemhWUTRhaUZIOHdJdy9hMERsOENuNjBJNUY0bkpTWDh0d0ZKQTdjZ2MrZkh4NmppUWxLVHhhbDRya2djU0h0Z09XaDA1cjczeXJ4L3ZDMVdXSER6Z1BoNEdzZ2Z4cFUyNmRKYXExTFhaRmx2dDZKbERMSzNPRGQvZUFMaTd4YXgyb2xuQWVxcHc0MXVIYWlDRE9QSFRwZDhPcWFWdVdjb3Vjc0RHY1V4VGI4dUpWVkxUa1REY1JGaEFBSk5tbHB0UjVteGQxY2JsQ255VUJQbmhzTFNPenZIMTFsZ0NGdGRpdUliKy9uZkt1UHZMYnFETWpTTFRFTlREWmJ1ZVJONjJXOHNVRWtkM2hxRVFlZEMxSG1MeDdZNmJqQklEaGVIbjFnK2J1NXB3Sk5mWTUxOE92a0x6TmMxT3JoL2ZBL0ZUdGJiS3Z5SDZNMnVyeklNRDBFYkQ3TVRHdzBpbkIyZStnWk0vZFg3MGh3K05KNUQ5cU1mMWNKVG8vNktIS0llTUFWRmtjVEd1M2wvWlpoNU9HcEsvQUgzYXJxUTFyNVo5azBlYkFFY0oySUQ5R0dIUlhleHR6SzVFWHhGVmVDcm43ekM4L1VlcWZjdGIzNGxJTVJQQkwyQk92eU5aRDBqZEhCbHpncEJKSmtYck1QcHVxVVJCT1VlRnRqYUxuSVptWmp1NWN0OVRyU3kyNGJjOFM1azR2bENsRWFxT3p2R3pBZXRkYmpKWkQ2dFBqb3AvTCsxanFDRWhMd0dCS0pCTWRKbTFGNGN3UVh1VXc3R0Y2SVpNb2E0OWhzSDdMYmtHZ2pTS1hTVk5DZU8wV3ppM0hhTWwxSjVmSVBBS2QwZmV3R2pKZ3V6eFBjQWp1cjJKKzhHc2NkMDRLSGI0T2psUFFPSi9MZGZZbmo0Szkzek1kMDZMWU10MTh6SldSK0l2b3NWamZYcVM2dGtiWXg3WllySzlXQTZqcDloblA1WnpKWmhneTkweXoyT1ppRTFCSG9lSkpRS0MxcDNuT3RkN1pxM0tWbk5lKzJraGxaOWVlOE5CTGtBWGMvbXg4MUpIRmdRTzRBV05kT2d6aWZWOVBWU0k4VThtNmdFK0dMUlRmR2lDWmdUWk14NTE5anhUVlV5K0Q1amJSZz09In0=" "eyJ2ZXJzaW9uIjoieDI1NTE5LXhzYWxzYTIwLXBvbHkxMzA1Iiwibm9uY2UiOiJXRmVEekJyV1lIVHRwZXVmUStOSm1rRnpTdWZqN0dBRyIsImVwaGVtUHVibGljS2V5IjoiMGJKcklxbnpKYXFOSHRHZWkvNFlsekxsMEtEV2Y5WDJWVFZ5MnphQWRBUT0iLCJjaXBoZXJ0ZXh0IjoiVU45NWhiNWMrMTR5ZUhkbU1Sa3AxcTZ4bWIrZndZQkxWY1l0WXEyRmF5MlBXRndkRWVqRHFWbFJ1VTJ5TDcvaC8yL3BnelZtMDV2ZDBmeUxwUmFZQzNEUFFab3NaSlJranNta2d5eExPMDBxQnZwaFd5a1NiMzc3WUduRDNoSFFwRW5HMDJuNUtMdzBkZW03SE5XR1RwczI4RGhUYktaN1NrRFArWjlsbXJyTk9DSnYwaDN2NjBXYkZvT3hoSnJxOTJXM3RVQ0NBZ1JEMHBZbWsvWUJKcFV5T1Bod05YMm1Ham1hay94VHhhODJpaTFsaWpQaGcxZXdLaWExbGg0djdBMExjSnNWandaS0ZtVm42T3FYUW52VnR4a3NucVdZYnpURTNSYXdnc2VLSm0raDlXNGVJSzJ5S29vYnBUVU1VNC9ndCt0YlBzNVlUS2JSaFJPcGQ3QjIzbHpBR2VydmMwKzNrYTFjaVBSR21yMzZ4V09ic2xob0UwRmlzY0JKb2NGRWphMEVEQ1cxWndUYkhiWnZTSUNqS1F0aGtTSlEzL0ZyN1p2dTloaWxpTkhMN3JmLzEraXQ5dC91bzFtcXhOb2NqZE9ZNDZhYXE4ZjQ0UjZyWlJJZHN4WTFlUFRKbVFSUUhHR3JYazBINGdXTisrMjBmeldTWDVPaEhDMTd1Sms5Y3BaZG1OY0FmaVM4RWZDODRRMTc5L04vRSsxNW8zdGtPdFlMWGhhd2JrbGd6STlpaXNzPSJ9"]
  }))

(print {"Total gas": (env-gas)})

(expect "fungible - deposit - sender balance (native)" 90.0 (coin.get-balance "k:aaecdc57dd287ab576f48f7357f470fd41e0060e83197df1fe86c6866698c221"))
(expect "fungible - deposit - contract balance (fungible)" 10.0 (coin.get-balance "opact-contract"))
(expect "fungible - deposit - gas payer balance (native)" 0.0 (coin.get-balance "opact-gas-payer"))

; --------------------------------------------------------
; [✔] Withdraw Transaction (coin) | Successful
; --------------------------------------------------------

(test-capability (coin.TRANSFER "opact-contract" "opact-gas-payer" 1.0))
(test-capability (coin.TRANSFER "opact-contract" "k:aaecdc57dd287ab576f48f7357f470fd41e0060e83197df1fe86c6866698c221" 9.0))

(env-gasmodel "table")
(env-gaslimit 10000000)
(env-gas 0)

(env-data { 
    "token-instance": {"refName": {"name": "coin"},
                       "refSpec": [{"name": "fungible-v2"}]},
    "recipient-guard": {"pred": "keys-all","keys": ["user1-keys"]}
})

(test.opact.transact {
  "public_values":[9634049270485623739522952278040765597599123811671707163189917519424521430627 2462739702657814117290699457271946217590207063464479909050869743897704207724 2853992871384324753633688434289512410444482507940147654721290740816844796502 11868083005274190561800786275022647184657472843951892512900714553524500443212 21625350193152129145588170396333098863652941036341209604177782866523740459951 7733089602521286885909099159069338919067493507395562087599909765654896248666 21641413519241433038728732482252681279852081107196128863334599825876610861026 21414792165107094930503066755869007218485843369153027361954450892852833682115 21888242871839275222246405745257275088548364400416034343698204176575808495617 14086762753250979343414985882978715367013614679395259249448992322459113644908],
  "a":{"x": 6000591385963797935591938864243916015897116191638894878094195383078329842224, "y": 15012282156594807749261955526679294754427564599527649295471386954739256568667 },
  "b":{"x":[13913492350910666851593085271414774491598600434445595639856525979976776051960 8149692919972371666876911697257708601960364802349580272755253186111166879474],"y":[11236444796077642329763719536325010225016462937251494225196628592873057354193 19839937196317341257896640490940176796957150738761414469657972991249114375768]},
  "c":{"x":20090779552069445791626314695591475169328888962805119314023406719755045948290,"y":9100498752375635565991155065727474685877255809013373736798418993421188366146}
} {
  "sender":"OZK1a71d0b02a82aa5b2db9d54cbcee8f9a21deea08ef883333500ebac1d39d55401d6f263634b62e5e9d3d097b3afdb358960a1ed1c87ee922ca5b8daa11490253",
  "recipient":"k:aaecdc57dd287ab576f48f7357f470fd41e0060e83197df1fe86c6866698c221",
  "tokenType": "fungible-v2",
  "tokenAmount":-10000000000000,
  "tokenId": "0",
  "outputCommitments": [7733089602521286885909099159069338919067493507395562087599909765654896248666 21641413519241433038728732482252681279852081107196128863334599825876610861026],
  "encryptedReceipts": [""],
  "encryptedCommitments": ["eyJ2ZXJzaW9uIjoieDI1NTE5LXhzYWxzYTIwLXBvbHkxMzA1Iiwibm9uY2UiOiIwZEdBZWVaQldHZCtoSmpqbjFjOEdGNHBXTGRXd3NyOCIsImVwaGVtUHVibGljS2V5IjoiM1JFSEI3WVZTTDFuS2tGRjlUUGg5dTlBRjdJUWtxcnZXQ0ZRQ3ptSThBcz0iLCJjaXBoZXJ0ZXh0IjoicVhBTWpWNWhJcnZZdWp3LzlENG5aMG45ZSt0QnZzdGFDRFVPQUJpeGdDd0xXd3MvK25iK3Q4UWlnSVg5dVZqT29mQ2xxMERwNHNZY3VCcXcyNUlWNlNEZ3ZCenl4U1k5U3RLSXdtVHR6Mm9VeVBZbnBXN0xmSUpWdXQweFFYUXEzeHF2dTJXWTM1SklQcE1Pb0JydTRzRG0yQkg2bXhieC9nSDBTWkN1ckhiYkJFa3lKVG9yUHJLZEVKcmhFOHVKeDBleEs0cVFBQmRXdS9RMXJRbXRlenE0NDROOTc1K0U1a1A1ZTdobW5UWlova1RJK3Q3T2FWMzdkS1ZKWnZ3YXREaXFXblVPSjI1S3NuVEZnaEdzM0c5Q3VtNFMyRlUzU0tWcmplNXIrb0tONW5pQUIybDFYNDU5VTM3c1NpOXZRZVpRYW1LUWV4cHVBbDVGQmkyUHFSM3YwUm93bE5BdDVJM3JkY1Vjb04xODN3SWdwSFVlSGlLWGRacHhzMFlPNEl0QXFDbURQeWV5WWRoQStxRlB2dUxReSthR25FMVRrK3lXZHBOcTZqU2E4SGZ2YzRVbVBFdWlHbDBCbnRSaEZrN0tQdkZGYnJxLzlSN1BZbG1ocUxHTUUxMUlhUlE0UzNKMitmS3pxZWdwVlVLOUhlSjEyZi81MEdFSEIycHZlb1NTNzJkeFNMd3RuWGJxSlhwVlppRFRCVHhFWm1jQXVHazhNUCtBbEx1Z2hIUjYrU2FJSDJKenVHZzVoNjQyYzdHR0VxdVlXaWRaUmpBNHdHMkNSSVZaQjBLVUNSMlZiTUlSQWE5Z0pJVk1CQ3ExdjdsNlpvdmhWMnVZSjI3Um1qdmpnUFJ0NFR5L0xlYkFVdFN5NndPME8vUVBiazhaOGNJUWN5RllTN3ZPUGNPVUk1ZnUyWGVNbFBVUHBsQ282YWpYUVE0SXowZnVYZVdKQlpmVkthaEl0a1B5WFk1ejNpRC9hdE9Jam5kdlFqZE5Ha0d0cmlEclhJbzk5NXpaZUZ2blR1WlNzMkNQakZTTGRuaDBWM2JLcU92R2dHRU12aWdaL0VrTVI2R1hQOUpyRnltT3RYb1dSTktkcHBPSVZCZ3k2Zjk3a3ZEMENnbVh6MXVXSmo2MU1GbnprN0FBVXlERjVGd3NHSU9yVzIvMTlTL1Z0b2VLcHUyWFlrNHVjTkpad2l0VlVFZmdaRkJDMUpPeWpOeDN5TU54aEJMdlNkd3NTZTFWeGkvMHdZVk5PUndpTlhuT0VLL1VIR1QrakE5YXhNMC9IUlVZMHpja0hBPT0ifQ==" "eyJ2ZXJzaW9uIjoieDI1NTE5LXhzYWxzYTIwLXBvbHkxMzA1Iiwibm9uY2UiOiJTc3hyR2NVT0h4bmcyQVhRZXNUdG9sZGlTS3VmQlN2QyIsImVwaGVtUHVibGljS2V5IjoiTE9ySllsclFuL3BqQUdBMVF4Rmd0M0dUVmV2SnJIRGxIamV4d3pmMGRFVT0iLCJjaXBoZXJ0ZXh0IjoieVpsNjhaOFRMSXBqQ1k2a1VLb3VhM3ZBSGFxeTRrTVpXOVk2UFVhYlkvOFYvOGNEaHlBSWFFMVUySkdQNmZ5K2QrempNU2xENzNZTUt6OGVNRmNZd1o1dnZtVTdZUlR1V05HU0FVWnd5SDFHSFU3cHlkOGZwSnhEYjk5eFg5MU80TmEwM3JuclgvS1FrbkNNcE1HcWJUSit4OG52eVc2OFhWL2p6TTBacC8zYk5GeStJV2kwam0zdnJuK080bUZPNVF2NzJsNFRlQjA5cm4ra3VEb0ZKNmdDc2owUGV5N1oxa1BCbmFDWGgyLzdkSC9mQlo1VUt1MWJ6ZkVCSjJRK3Rsb0pLWG9vdTRYNmVzckEyZkQxeFd6VE9IeVNsUUpWR0dqVkJmUU5hd2l4TThLVHJTSklmd2xSclZnZXpmTm4xWTZ3SWJ3eE5hdFgveUpHOHRMR1dkR25UejNSSHZVbGhFOE5Nb2pIMGlRWU1rTFV1T2pBU1pPYThxNXVjV3pIVlpwRGFkK05Db1pURkhDUEw3RDdEeDh5NlZ0YUZFUC9oZnFrTzd1eFh2OEZSdXJKY25SdldBYVJESXJ3c21mNWxDTHlWOTVqdUVnSmUrZEhzZDhSd3FtTzlyczN0a3RUZVJvMmxiVjQ0OVpQTEN3b3FSdzBMb1ppdWlzei9ZU2l3NHJLTXNYUW5zQXA2NDJCVzBMamRuWDRzYTREV1VOQ2s1YlZiVndaaUQvODFTM1FVb0FWSUE9PSJ9"]
})

(print {"Total gas": (env-gas)})

(expect "withdraw - recipient balance (native)" 99.0 (coin.get-balance "k:aaecdc57dd287ab576f48f7357f470fd41e0060e83197df1fe86c6866698c221"))
(expect "withdraw - contract balance (fungible)" 0.0 (coin.get-balance "opact-contract"))
(expect "withdraw - gas payer balance (native)" 1.0 (coin.get-balance "opact-gas-payer"))

; --------------------------------------------------------
; [✔] Internal Transfer Transaction (coin) | Successful
; --------------------------------------------------------

(env-gasmodel "table")
(env-gaslimit 10000000)
(env-gas 0)

(test.opact.reset-nullifiers)

(test.opact.transact {
  "public_values":[9634049270485623739522952278040765597599123811671707163189917519424521430627 2462739702657814117290699457271946217590207063464479909050869743897704207724 2853992871384324753633688434289512410444482507940147654721290740816844796502 2233260913863499610337726142020783872351741774086722697180128199353278981942 19702366304090081281564831470661499997671768859899274134733378954865627601771 5850751451101690885877910052162494733622640793973188252423701488709649016157 9321537227890345914054028410541223900330935769711259528701598802997324219920 21414792165107094930503066755869007218485843369153027361954450892852833682115 0 6325603060621877140081756488186012264247999407561226578659417643173091536101],
  "a":{"x": 1206738353281261109459884281905289993722081391203893495349773939962201934123, "y": 17158627641420460520377858797870469058253788057727708377676211431219318059119 },
  "b":{"x":[3917168478782926622465523030213151240774652023615770325344786016872696898990 870346134409468431818617095866996733125108950091048535499399943182680766917],"y":[17504644263094976755665211134538453587112857086098477919444815127944476713842 1190336426918156803193554748770615945152534360807253048255208203382782160578]},
  "c":{"x":13744161806381909799383650547881060190795041190769702270988346965567117133046,"y":13073059712479751367281794179734660989335965965015230388340736118856181610560}
} {
  "sender":"OZK1a71d0b02a82aa5b2db9d54cbcee8f9a21deea08ef883333500ebac1d39d55401d6f263634b62e5e9d3d097b3afdb358960a1ed1c87ee922ca5b8daa11490253",
  "recipient":"OZK1a71d0b02a82aa5b2db9d54cbcee8f9a21deea08ef883333500ebac1d39d55401d6f263634b62e5e9d3d097b3afdb358960a1ed1c87ee922ca5b8daa11490253",
  "tokenType": "fungible-v2",
  "tokenAmount":0,
  "tokenId": "0",
  "outputCommitments": [5850751451101690885877910052162494733622640793973188252423701488709649016157 9321537227890345914054028410541223900330935769711259528701598802997324219920],
  "encryptedReceipts": [""],
  "encryptedCommitments": ["eyJ2ZXJzaW9uIjoieDI1NTE5LXhzYWxzYTIwLXBvbHkxMzA1Iiwibm9uY2UiOiJGbVVFMlA1dk96MnhPTFpNNVhQdDNPNFJON2lHMUJBYSIsImVwaGVtUHVibGljS2V5Ijoid0ZJbEFJbWNQaEZDT2M5VVE1OXB0Z0pwUkpvTGZaY1pzS3RjdGYweWZHcz0iLCJjaXBoZXJ0ZXh0IjoiUDRBWjFob05wazU2TmltV1praGdOeGRVcTNMYjFlVEJFNUt3NGJBMnRzZ2VpZVdzY2Z4UjZkcGxabk5FLzZVSURsMkN2L2VUY2pZYVpyamZweUN4YVFGZUJDbmNYZmdmazhsSW0xSXkzUGxmUUdTM2RvVXo4dUhqNTNuK0FkQzlVaDNhT3FUYlIrMHg0OWRscFpnRTlvRUp0Q2wvbUNIb2ljQzhBNHo5YTVDQmM0ay96TEJsSXNiV3Vsb2pWZXdCTkVoZllSNWtwTlYxTmExT0NFaDFKV0gvMGZSK3p0SHJrUDZzaG9xZnVDRG93MjBTZUF3YjAxRU83VC9mM3MxcmtjOGhvWk9ZeTdoVmFKMzNXK2xZaXlXR2NIQ0p4bEErUURHUHNMaXJkdmpSR0Nhb1o0UXpPV29rbTdVbEpZM04zckRUL0h4aVljdmFjQ0ovcTdVV3Q4N0RuMCtQNXNtZHhaWWphWDBudDBENGdhNkhCT0p4bzJ4dGJQZFgrTko2MXpZcmtqUHpLTmhLVXQzSzFHN2wvcUdGUWZSaUNOc3NDcWRNdTVMb2ozcWM3eW42OE1lbk1OTGdOUGE0ZFJRZHNOSzBmQnpOVUwyTHBBMTc3L2dPODZoUTVuMDlWSG41RGt4NVFlN01sbCtLaHJFcVVVWDEweDBWVzVXWk9lL0g0KzhCVmZpL1E2dnBTWGpjMnptbDk4TEpMUXd5b1FFVjRYam5CTGV0ckJlWnljazJ6S2hLa3cxaDNMY1MvY25OY1FnTm5CTTFkWW5mcEZjVS9jazY5dEp2TlkxTG8vejY0c3FvT0h0RHVVMExlTVFlbHE4L2tQWVFwM2xJWkM0dFFjYUNCS2N4UzRtUnV2d2NmTGVJWW1TU3dna2pER2xGRk81a2ZHSmZUMTdqdGlrWHhTdHpUWFpUV1h2V0lycnUrQmxnTFh1MVcyV0huRTdMd2x4anVkNjBld0NjN0dtR3puWmprRmh5Wm5PV1Q0V3d0QzNnbWVSaDRGVXhSbllVNmJ5cmpJWE1YTjZaQ0hMNXdLbXo0dDRDNUx4L0lidmNJb2tnSU1CSDZQV1RvRDJEd1dab2J1RlR1WWs5Q0QreFdkd3RzWngwMk9zNkE5b24weUJTdEoyZ1FVdFZ6bnlzTEhUS1BPNDJjTThXaTZSaHIweGYxT0MzZWNJRjZRY1RlVk5hcHo0UlFnL1IyMytNM0h3Zk10d0F1bWZGUzJ5NjJrZy9ETFF3QnBuRGw4VnVuT0gyQXlUb3gzY2MrczVtb0grYVdlaXdkL20vWFVkMmhXejROWDE0ckNHblo1OVZDZW9xdXd0a2s0MDJDRFk0bThHTno2Q3BoQlRvcUVOL0pOeitETEdoU1NxTXNTcjJmWjlUMDFEemRJNHBkYnFVTUhoTlkycG8ifQ==" "eyJ2ZXJzaW9uIjoieDI1NTE5LXhzYWxzYTIwLXBvbHkxMzA1Iiwibm9uY2UiOiJOSnUybUducjVxM1d0ekp6U0RzdnhhZzNuQXFwR2orUyIsImVwaGVtUHVibGljS2V5IjoibEhmOXVJdkZUZmVQalM4V0JQbUl3UHdwVHRHaHl0a000elBCTWxuTUxtWT0iLCJjaXBoZXJ0ZXh0IjoiOGhULy83cjM5NDdSRVpydllLUjZyeC9SYm1XdGx5bDJ5RHVKRmNVRUhUaDBRWVBhbGMxaFJmMGd3QS9teGtqYkhERUY0ZnhFZTRTNVJGNUFIZ1U2azRSaW9kcFJxT2hRY2JneXR5ayszbDhTc3E4ZHQrZ25Mc0VtM2dwOTF1VWVQdnM2OXJTU1k0YmVhV3dCUXJIZ29tamdHMlhCRkFTOG1zZzUrYmZYdDY5MHp3VUhua2NtWXZqYW5oNEtSZkRBVHJud3Myd0h5K0kzU01DdXpUL1RwZWNhVWg1YXFYVGd3TENWU3ZjWW1ubklMZHpHdHkvSjJFTHZzZzNRZ2hNaThIdUsrRDl3V0ZYMkhPZkwwaG55UWcyUUFYWFZtank0N1FKZXpoakZxSHRwcGQxVXA5SENYelhaTG9EQllONDNoYnNLRFBEQ0pjeCswVy9QS3VHVjRBWGlEcnZYMDlQaHZmb2FaSnIxdVBZNnhhNHZ0TjRjL2ZTOEZMVzh2TncvS0UrSEIzMENPZGVGSUtndnNsN1gwWllGVHR5L0lWWXdWVWR6T3VkVDR6ZFg2TjMzM05CZ3l0WERCMFBHcHlGd1VqME8xSWUxMUI2akVnM3J4eDhYUE1MdGsyeGNyUjBURnEwUC9rT2t6VE9JK1Ayb3RqWkRueExyZGRXdE85MnZ1RXFOV2tvSkJwZTRPVHRpTnRHc0wrU3kxS0xLNEQvdUNzN254MSswY1pxdGxMV0ZmQ0czNkQ5b3pubG1YV0F2RWNsUHlvTDlDakdlSXFxYWFWKzFyZ2ZZeGYwWVVGQzZQWVBCZ0oxdDhkdHBwVUtxSk5GL1I4NGQ3MFpMb1c0b2k3ZXpZcGQvV2pOdUcrbU1ndVlJSDBpSEk2clRLdXVoNGhIbHNIMXFIOGlkcE5SMS9naDRuSjRFWmgyT0RtcExBS2R5SUowamtXdEE5eExGK0oyMlpDdXdna3gzOStGS1h3OGU2T1lnRURQTkkwMEplRHZncjJJZllOaGc2d3pTUnRJV0M2SGExMVp4cTU4NzBDdUc2NlgrUE1ucStsK1l3dzN4LzlOREdiTDl0a05xb1o4enFUenVmcHd2dEpGQXI5aTl6ZnlkS29KUWNKSXR5Zjd2dDhuNGtHdHY3c2JYNDNMTDAxWnByUXlGaWN4WU1hR2JQYlpYV3dXaURBck52STJINVVsYUI0QnhYTmNlWlRHY21wQ3ZMTlRWLzg3SWhDUFVmNGFlY3lKMFVKQXpERVZwWHBMRmhzM2tWcVR2dzBPRmQzaGh0cjhlY0pyZFlUZVZ3QU52SGdoUDRrMEdoWUhEaW5IbWsvWStveXF1Z2RVdUp4MDdEZ2dya2JGYWdIbkYwZ1hSYitlTHVxUElDSldJMk42eFp3RUhrZlpNOTVrd0lBSnBMU0ZPWHVuaG8zVUM3TzlqIn0="]
})

(print {"Total gas": (env-gas)})

(expect "transfer - recipient balance (native)" 99.0 (coin.get-balance "k:aaecdc57dd287ab576f48f7357f470fd41e0060e83197df1fe86c6866698c221"))
(expect "transfer - contract balance (fungible)" 0.0 (coin.get-balance "opact-contract"))
(expect "transfer - gas payer balance (native)" 1.0 (coin.get-balance "opact-gas-payer"))

; --------------------------------------------------------
; [✔] Deposit Transaction (NFT) | Successful
; --------------------------------------------------------

; Setup Merkle Root
; As initial state, we are assuming the merkle tree has the following roots already inserted

(free.merkle.insert-root "1" 18713872636206827830288697988758812970004557540569224193678225325902995302590)

(test-capability (test.poly-fungible-reference.TRANSFER "1" "OZKddff7510ffee60954ed179932439958d1359ba6eff6fab5ecefd208df8cf43701ee7dc8c2f7cd09cc87825f77a8ea057319c1efcec92f64e8be2387d59379d34" "opact-contract" 1.0))

(env-data { 
    "token-instance": {"refName": {"name": "poly-fungible-reference","namespace": "test"},
                       "refSpec": [{"name": "poly-fungible-v1","namespace": "test"}]},
    "recipient-guard": {}
})

(env-gasmodel "table")
(env-gaslimit 10000000)
(env-gas 0)

(test.opact.transact {
  "public_values":[18713872636206827830288697988758812970004557540569224193678225325902995302590 21443572485391568159800782191812935835534334817699172242223315142338162256601 10922810363922605965214348397323724095131442262346529934384099161442544680003 5847848340780048016661645984125029358008056043912473632515729508249254393196 10215921305029504667961585252413812875796762880334927713628813725645671038878 3180613669211884235659963339860388599808923412079933119027472704157493507317 20031907712727911758929535518094505295147050481352303703830861724641165059430 17684566106018502551390726531083472890545962461561174022391021151438683652934 1000000000000 20757347348391483233719521097764616165434566003630466313725398069019223706955],
  "a":{"x": 20210078674509866038410766852019395110369983636032049122979537575552811207592, "y": 11042845964080927982276076817354514508319649293838228011642575917222586538847 },
  "b":{"x":[3385234478241143213331831107094038353819860154949131138489727569614455059806 16751276355194893276088311489780923476272367548975021259837685374210436137092],"y":[13638055838988645606429895880113861465757777995034622411032165936439004784301 10390922705210383624022185818747067068926468913421449646732316630509845193718]},
  "c":{"x":14067195142236767874857476656208674153024455086456189919754986623935648190356,"y":2029408119910753474695270373169984967475500481966559861186307950008033624654}
} {
  "sender":"OZKddff7510ffee60954ed179932439958d1359ba6eff6fab5ecefd208df8cf43701ee7dc8c2f7cd09cc87825f77a8ea057319c1efcec92f64e8be2387d59379d34",
  "recipient":"OZKddff7510ffee60954ed179932439958d1359ba6eff6fab5ecefd208df8cf43701ee7dc8c2f7cd09cc87825f77a8ea057319c1efcec92f64e8be2387d59379d34",
  "tokenType": "poly-fungible-v1",
  "tokenAmount":1000000000000,
  "tokenId": "1",
  "outputCommitments": [3180613669211884235659963339860388599808923412079933119027472704157493507317 20031907712727911758929535518094505295147050481352303703830861724641165059430],
  "encryptedReceipts": ["eyJ2ZXJzaW9uIjoieDI1NTE5LXhzYWxzYTIwLXBvbHkxMzA1Iiwibm9uY2UiOiJaWWc1QVM5UDF3QUhDWGlUQzA1S3lVUzQxS2xoT3hXdSIsImVwaGVtUHVibGljS2V5Ijoic0d6bnpUb1VLd25sL3UvdWJnMFRqRjE2bHg1Y0VOM2RocGpKZWlLQkVFZz0iLCJjaXBoZXJ0ZXh0IjoiNzNETWpYSnk5WnRCaitwQ0VKR1NqZTZpRE1Na25veWlHb041TTJnQWQwbngxSE56RjljYWtpSnNOWjdJR2hPdU9adVk0NEFBL2ovN0xKeHplK1VaWk9xUGdlWFZxY21pYlJNdUEvMDBxaVVwVUZtcW5HMkF5SGhZQVRsRVZDOUNiSXR6U1hPWVFyTEJFSm9UUVB4T1JRbUswcXB2MDBnenk1aWtEejNadVErekl5UVlkb2J3dFF6NzV2Q1RZSDJ4YS9ON2tveUVWakkreFVzSkpnMDNrRFNmOFNWNFJyUWp2ZTdLcldYcC9nT25NOWYwMG9oeENrZGdLc3JEMGd1Q0E1VEdvYmlzRjZhMzQ2N081cVhsbUxIVHZRbmg1V1AvaHBGK2lobE9MenZ2U0JteWhhWXNLdlpHbDZrTHR5ek42M0NMNDM3MWtHN29qcU1zNnZobXo2QmgxMnBLU1VUVzBXb2N2VFh1YzlRaVFGZW9TTUNGSG9iZUt4TFdUdWV3Ync9PSJ9"],
  "encryptedCommitments": ["eyJ2ZXJzaW9uIjoieDI1NTE5LXhzYWxzYTIwLXBvbHkxMzA1Iiwibm9uY2UiOiJUK2dudWxnU21WclpTWk1UcVBFbGxvWGtWRnF6ZUJwVCIsImVwaGVtUHVibGljS2V5IjoibzdJUEpHU2s0NjB3Uk5JNWZUSzlKcnZFQkVTSkxJRlQweXFQWXMyNFowZz0iLCJjaXBoZXJ0ZXh0IjoieVFVRHVXMjZpZ0U4OTc4ekpRWDBRcll6WkFFbVVOUHZiZnNDN3g5MWRkMEMrVmF6ajgrWGlBQnd1Z2NucHdFcDgyS1BkdSttQzUvOTRXbmtLWHNOZGFQSE5QYjl0cGFzeHBoQ1crSmg2VzNMRmgwWmVVeU94emFQY2ZTcTZhVE16c2pLUE1ITE9xbTZpNTE2R1p4eUZuY1Z5QkpMc0RkSU1kekFXYTl4ZThFaXRYVDRFdEZrNXF6M0pKaGRHL003UE5vUWUzRlZLWVIxeThZY21GcW5VeGw0M0xBQTZTZ2xuV3hTS3Q2RUI3REVad3ZSSWtVT2h6b3lZYWRadUwyTklVMGVTKzEraDRqZVlJeUdSZEVMVGR2YTNaWHkya2ZrL0tzRzdYaml6YkhJQTRVZ0xkUmlrTDdPWjZkaGtoMFlyV05vdUptVlZRY2ZBRVhDY1Q1Q0Y0dHR4Mm5aZk85QUYwS1ZwRURncjZnNGpZVnI3U0V1VFlxMUtSMmRoS0oxMG5yQUpHcWhjREV4YW5IT243OHRER0VIdmNoSFRTOUNWQ044M2xic0VtaDd6TmUwR3pVQzZidU5NM0Vhd3FlbXZsekdsVzZQZ1ErZFJmNGVYT0ZnckZtOGVrUmFmOTF5YjhMOFRCOEtvVkROTFQvaGk1d1p0SlBBYU1qZXFkZWRKeEx3TTZORVhsL0VhanBBNjAwYkVEeDRuN0YyMWxkdExmK1RodndtQ1FWb2ZJNnVoRmFrMFBta3lXRlhoZnlrV2M3NFlwUEpGa20xQmYwelpvTy9IZzR6UmdFPSJ9" "eyJ2ZXJzaW9uIjoieDI1NTE5LXhzYWxzYTIwLXBvbHkxMzA1Iiwibm9uY2UiOiJ3aFhJMXkvMWU5dHJQMDVudzFxMDRGRU9qZmExN1NyTiIsImVwaGVtUHVibGljS2V5IjoiUmZ6ajNKaWRKZXdZVjNhNEo4akFNL0ExZXJNNXIvNFZIbm53VG9KbDBTYz0iLCJjaXBoZXJ0ZXh0IjoibTRBeTk4bXZlL1RJcFRRTTdBN25vcDNoajNsb1BvdGVXRjhONHFMNHVkNDZSS3JBK0xCdFJnUHdVeHhuVW5FeGRQRjk2bmxhd2c4dUZwWTlSMkl5VVM3S3MzR2xZcTZRa0xZeVloeDcxWis4cEZUdG5jZ1h5UDdEUkF2UjJVSmVkM2U4SzV5eVZsaVBCZVRjZEdSZ2hTdFBaQTRCYmxPaHo0ZkR0RnFMcnFNYzFSSWJJay9TTGNDSWs1WFNjaG5Vcjc4L01DeEdUV1o2RWp4eXBUNThtZURkRHpHM1k3YmEzSnU1TnMvc1pFKytwbFd2SVpIT2FIRTVaL1RiaFZGYmZaV0ZLSW1LZGVMN0RQTncvNHhoeVkwVnJxYWplNHVXak50WXgrNUFVMzZSbmtuMld2SnZ6YWMyd1pIZmJEaS9kb2cvaWhBZVFvdDNoYkdHeml3RytJbHRGdTF5VnBMaXBKenN5cHgzS2Y2ZVhWYXBPMGs5bzcyZkx4OUxDa25rci9xbW1jb3ZJcW93TmtpcDZKSXVtcVFIZDQwL1YrZFVzMzJjVVZzeGNTZ3VCM1N4MDJEdUpSeDA2b3o5eXlaT2g3T2d1WFRsaGJpVldlL3FNMHY5NGErQnNXRDJxU1V0U2VFRWdJWHVSRk0rSVltZWljMmhySW5Hb3NkTUhRUEY5dktsdm56bnNFZ1NTeUNSbUIvdnJLd0pPYnhTVHkzQkxvSlUzQll1cXZNbUlpYUZpblE2TTc1cW5OVkpqTlNzMTk2MGpqWnY1Skc0dDNFPSJ9"]
})

(print {"Total gas": (env-gas)})

(expect "poly-fungible token - deposit - sender balance" 99.0 (poly-fungible-reference.get-balance "1" "OZKddff7510ffee60954ed179932439958d1359ba6eff6fab5ecefd208df8cf43701ee7dc8c2f7cd09cc87825f77a8ea057319c1efcec92f64e8be2387d59379d34"))
(expect "poly-fungible token - deposit - contract balance" 1.0 (poly-fungible-reference.get-balance "1" "opact-contract"))

; --------------------------------------------------------
; [✔] Withdraw Transaction (NFT) | Successful
; --------------------------------------------------------

; Setup Merkle Root
; As initial state, we are assuming the merkle tree has the following roots already inserted

(free.merkle.insert-root "1" 15733110032231408440408102347121434985639321029421407976386771597061156033705)

(test-capability (test.poly-fungible-reference.TRANSFER "1" "opact-contract" "k:045d640d3abaf87670e2676c094629e29d1665ef6f409fde0247b606ab552131" 1.0))

(env-data { 
  "token-instance": {"refName": {"name": "poly-fungible-reference","namespace": "test"},
                     "refSpec": [{"name": "poly-fungible-v1","namespace": "test"}]},
  "recipient-guard": {"pred": "keys-all","keys": ["user1-keys"]}
})

(test.opact.transact {
  "public_values":[15733110032231408440408102347121434985639321029421407976386771597061156033705 4471649153974372772130620433941951769580887618040723627976879310391701680691 9568593551094607082782700899274173947979710814864962410669927521980034355123 3725280554632204922270154080732985292552099827925345773220905927763337609353 2143491370270635356531163544799798012859784256885160730845585149825250894246 4839839330491344626037192489170849657414316620014490606184043293380149175337 15253351345020801398120763794750127016761608962427346661458988844249166313805 17684566106018502551390726531083472890545962461561174022391021151438683652934 21888242871839275222246405745257275088548364400416034343698204185575808495617 13055358970678311504349430275624939238675806958250208872188355999661766245043],
  "a":{"x": 18358545619938234293247314039600741275735339089894342771618155487060416078273, "y": 20301033291889516560125447245698020528971022541409658709230763235628882717743 },
  "b":{"x":[11245783392110601680810438990287878703666475385839342180027906385107308135051 619640647387696798193252453097811606156159975208136154216183432925099353086],"y":[1559877182299347510048417668847003535244164780053210670882554719127247926836 7562899685072640445090476525166727300138540184319162752917181238112424196754]},
  "c":{"x":5292089121649643438816270518210662813085974874994298941220938589326832843190,"y":4387062864102269448908339466694367332703508348816113613107513098831570571839}
} {
  "sender":"OZKe663d7f72b3fa10a47531a72088c7ce37527c7f6c800aed6bae05836058f602c0129c97a71a7a6ae0b70971739b89b3be9faad9d2e51961c5c2451352dc7ff33",
  "recipient":"k:045d640d3abaf87670e2676c094629e29d1665ef6f409fde0247b606ab552131",
  "tokenType": "poly-fungible-v1",
  "tokenAmount":-1000000000000,
  "tokenId": "1",
  "outputCommitments": [4839839330491344626037192489170849657414316620014490606184043293380149175337 15253351345020801398120763794750127016761608962427346661458988844249166313805],
  "encryptedReceipts": ["eyJ2ZXJzaW9uIjoieDI1NTE5LXhzYWxzYTIwLXBvbHkxMzA1Iiwibm9uY2UiOiJmdUhqS25xbE1xUmpicFpkV2NwelpBMnkzb3pjS2w2biIsImVwaGVtUHVibGljS2V5IjoiTHRLNFFhdTBzaGFIVk1VbFRacG1nWHI4L2xXRXRhUFE2SzQyOVV5RWNrdz0iLCJjaXBoZXJ0ZXh0Ijoiang2Q0pnVURQY2srVnh4cmdQdnFaTnB5N0R3S3BkMkdLclRPdzVLZGYrWnF1QytiWkhvNm0yY1RQcjNsajFuWTIwMGIyMmhZd2E2SllYYjVUQnJrQU03SnVMbldIT2ErcHVrYVZPWE9HQTc3UmM4WHdLSTNiUlVCczlWUDlvVVd0WDcyaTh5UitxU1dkYkVsajR5VER5dEJGdHRyK1ZiTG5DaCt1NkNMeUlBaXFWT2wveGl6dUVkTHBVUUY2Wm5lMDcrUEtFTUJwNGVoR1FmK2xTNTZLNlNwcWdYY2kwbUZBNlYrdFQrTG91VUJFZVpYU1ZDTXJKbjVvd29zdCtDaTdlVzh4UHZta1Fid3BJb29mOHdZYlN5cWJDb1RxQldJK0pkZ01zU0xSTXlRMEpxU2pWWFRVZU1RdGhJWERKdStTZXJNUUZLR2NxcDJEWUpRRytXYVRFQ2VLMTcxZ1dnMXNtTUlLZjR0aHFtdFZvank5c2VISnNwSXphMzNqMUhCSEU0MktBazZrTDQ5c0h3Z2xOMDhZL2FUb0YzRks2T0IxcFRhTGl2bEgrT2h0eGJ1b1gra3IyNlZhVGJaQzVSVVlJUjF3dzR6WFZ2U0prNmMifQ=="],
  "encryptedCommitments": ["eyJ2ZXJzaW9uIjoieDI1NTE5LXhzYWxzYTIwLXBvbHkxMzA1Iiwibm9uY2UiOiJrL3FQYjJaOFZKKzNDZm11c0o5dEJWM1k1Q1htMkUxMiIsImVwaGVtUHVibGljS2V5Ijoib3hVSG9FRzUzOEhZUkk5d2FwaWNGT3RWSlh6NHdGbWFrbXNybkFVKy9oaz0iLCJjaXBoZXJ0ZXh0IjoidFR3NUJKY3F3SG1CQmNZMXNUMnlwdGFxSzUxTUZETzlIdldIeDRhRm1MWUJRYlM3OVlXTGVNbUF0QzVwLzFBTWd0L3FzN3RLd0hmUG9iMjRQVmJRckMvWmFlRldPdU4zMnl5eEdCY2hEOVpPTDRJb2JITFFqMC9IamFqRCtrdHN0NitNd2pxOXNBRVBIUTlKQ2VhQS9RbE5BYnZHSWRMVnRkMzJpUW5IUXkyb3ZheXNHUFBCTDc4Z3NvZFpXMTh5dXA2TzgwckljZ3k1ay94L0xUWmtBamJBeTV5YUYvQ3kzR01nTmsrak5EWTNtSXdtUjRLSlI2cUtCMEV2dFd4NWtDODA5VDFKeDJIOFV0dTg4bC9TTXBoZVVPUUJ6Szk0dWhNdUhNV0Z4ZVdiM1FDSTNIMm1FSS9Wc25JTFRtK3ErcVlocWRCQTlZZjQ5N0IrRzFEY2NRWkJadUVjTFBJYm9oL2Jqc0RYTnNRcVhGcWF5Mit6aTNidXZlWDB3Mkg0bllCNDREdFZWZ09nb3dxN0x5TDIrY3RsdmVtZ1N2VjVxeW5PMStSNXIydWVJNGE3d0MzK2kyekhEWUFnenhIVUQvcWtMOTRGVG1jMGZ4YVVmVmMzbVZEQ3IyUTBDdGRwSndpNTI4VThDUDBHT1FzclhGV0h5RmdRMlVaaDRScGsvaC9LREw5QUFRYlU5V1FaaVRmbTJtb1NFYVJBVitZSUxybkpPcnVBbzhKdDVONVU0MWVBdDFvRE1qZFI3VzkyRjAzU3YxckV5bzA9In0=" "eyJ2ZXJzaW9uIjoieDI1NTE5LXhzYWxzYTIwLXBvbHkxMzA1Iiwibm9uY2UiOiJLbUJZRUlNVG02aE9ZckZYQVk4NHlvNGt0Q2xtMlkzQSIsImVwaGVtUHVibGljS2V5IjoibTBDZ1VQMXlCbS83L01SdVNLR05PQUR3cytsdzFjZXBDaVdBeVZsa2JoOD0iLCJjaXBoZXJ0ZXh0IjoiU1JlS016RlNOcm1nblBYelpSSlNnTzVGZUJVUzhUQUt5M1FzdHlKNUpSdjA3R3hIYnYyVUhRNFI0L3BsWHIwTklDdVl2RzlFeUR6ZDBBVnUycjlCeVBlU2hsbHlmV3ppaFo0L2hUSFRDbzI3OUUvWm9sa29UYlJCZm1ZVy8zenJtNnllNW9rRDB2VXhlNGxEUWRYM29jR3JhbnJqNkFyakhFMlFxSGZOMGErdEdRN3VzZ2VudjhZUXBuUDFuYmwxbGNoNktmU3dCaDRoQ3dxOW96N1FqWVRad1dIYlBYNmNYK2V6b1c0M0pTSk01eDZldkFpVE96WlcxcjFtUzg4cUZTWjJ4QkZFWW1INjJuMlhUUzl4N0Rwc3I2THpPNU1qSjduWURRc2NrZjVzVlBPTmxQK3V6S2l2cTd5MkQxK0pLdHUrc0RXSVJLYUFMVkhqZFQ5Z0hNdXU4TTU1SUhpbHhlVjJUS0lmZDdiN1M5N3cxZDJWdlJRWCttK0lRMk9RRDRuT2pLajRwVDRzRHhybEZnc0l2ZWN3NTdaS2ZNT3lwSzFTeE1XSU56VTdmL0JaQm9WSWhPb3Yra2RlcjhITTVlYUplbDJETzZoNDMzZFArWVcwcjZOZ1dwZXFNR2RCT09iT3RSNUlDcDFKT0FmN3FieEdSNnBBdjBCQWprWUpwUzNKMDJSbVJic2xvc1lEMGxvcExkOWtoQXR2aGRURHVWRzVVN0pUSDIzOURZV0dOS1RzdW41Y2FKZU5MNjZtOUF6eHAxY09YcEI2UVE9PSJ9"]
})

(print {"Total gas": (env-gas)})

(expect "poly-fungible token - withdraw - sender balance" 99.0 (poly-fungible-reference.get-balance "1" "OZKddff7510ffee60954ed179932439958d1359ba6eff6fab5ecefd208df8cf43701ee7dc8c2f7cd09cc87825f77a8ea057319c1efcec92f64e8be2387d59379d34"))
(expect "poly-fungible token - withdraw - receiver balance" 1.0 (poly-fungible-reference.get-balance "1" "k:045d640d3abaf87670e2676c094629e29d1665ef6f409fde0247b606ab552131"))
(expect "poly-fungible token - withdraw - contract balance" 0.0 (poly-fungible-reference.get-balance "1" "opact-contract"))