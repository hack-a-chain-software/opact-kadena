(define-namespace 'free (sig-keyset) (sig-keyset))

(env-data 
    { 'ns : "free"
    , 'name : "merkle"
    , 'user1 : ["user1-keys"] 
    })
(env-keys ["user1-keys"])

(env-gasmodel "table")
(env-gaslimit 150000)
(env-gas 0)

(load "../src/lib.repl")

(define-keyset "free.opact-admin" (read-keyset "user1"))

(print {"Total gas (deploy)": (env-gas)})
(env-gas 0)

(init-admin (read-keyset "user1"))
(initialize)

; A Merkle tree is built from the bottom up, where each leaf is a data block and non-leaf nodes are hashes of their child nodes. 
; The root of the tree, known as the Merkle root, represents the entire dataset. Changing even a single block (leaf) would result in 
; a different Merkle root. 
; The poseidon-zeros function, is used for handling empty or uninitialized parts of the tree. 
; This function generates predefined hash values for "zero elements," which are used to represent empty leaves or subtrees within the Merkle tree.
; The test values below were used as reference in javascript libraries and obtained the same result as here.
; Anyone can obtain the same results by building a merkle tree of height 32 using the poseidon hash function as zero element.

(expect "merkle" {"root": 75384953468489046983911671876400248222449372029672832467076510649225676077, "index": 1} (insert-leaf 0))
(expect "is-know-root" 75384953468489046983911671876400248222449372029672832467076510649225676077)
(expect-failure "is-know-root" (is-know-root 7100261737961175651894661471628070425717871781918545820690660904436371636492))
(expect-failure "is-know-root" (is-know-root 433691966820481170835612732662415018601648678037719227187608695860310427976))
(expect-failure "is-know-root" (is-know-root 7098826222200342209188065928557332008815532855779868708346378343137310353829))
(expect-failure "is-know-root" (is-know-root 5761155846399808156424816482501372050616463271338541789615967734134838540609))

(print {"Total gas (insert-leaf)": (env-gas)})
(env-gas 0)

(expect "merkle" {"root": 7100261737961175651894661471628070425717871781918545820690660904436371636492, "index": 2} (insert-leaf 1))
(expect "is-know-root" 75384953468489046983911671876400248222449372029672832467076510649225676077)
(expect "is-know-root" 7100261737961175651894661471628070425717871781918545820690660904436371636492)
(expect-failure "is-know-root" (is-know-root 433691966820481170835612732662415018601648678037719227187608695860310427976))
(expect-failure "is-know-root" (is-know-root 7098826222200342209188065928557332008815532855779868708346378343137310353829))
(expect-failure "is-know-root" (is-know-root 5761155846399808156424816482501372050616463271338541789615967734134838540609))

(print {"Total gas (insert-leaf)": (env-gas)})
(env-gas 0)

(expect "merkle" {"root": 433691966820481170835612732662415018601648678037719227187608695860310427976, "index": 3} (insert-leaf 2))
(expect "is-know-root" 75384953468489046983911671876400248222449372029672832467076510649225676077)
(expect "is-know-root" 7100261737961175651894661471628070425717871781918545820690660904436371636492)
(expect "is-know-root" 433691966820481170835612732662415018601648678037719227187608695860310427976)
(expect-failure "is-know-root" (is-know-root 7098826222200342209188065928557332008815532855779868708346378343137310353829))
(expect-failure "is-know-root" (is-know-root 5761155846399808156424816482501372050616463271338541789615967734134838540609))

(print {"Total gas (insert-leaf)": (env-gas)})
(env-gas 0)

(expect "merkle" {"root": 7098826222200342209188065928557332008815532855779868708346378343137310353829, "index": 4} (insert-leaf 3))
(expect "is-know-root" 75384953468489046983911671876400248222449372029672832467076510649225676077)
(expect "is-know-root" 7100261737961175651894661471628070425717871781918545820690660904436371636492)
(expect "is-know-root" 433691966820481170835612732662415018601648678037719227187608695860310427976)
(expect "is-know-root" 7098826222200342209188065928557332008815532855779868708346378343137310353829)
(expect-failure "is-know-root" (is-know-root 5761155846399808156424816482501372050616463271338541789615967734134838540609))

(print {"Total gas (insert-leaf)": (env-gas)})
(env-gas 0)

(expect "merkle" {"root": 5761155846399808156424816482501372050616463271338541789615967734134838540609, "index": 5} (insert-leaf 4))
(expect "is-know-root" 75384953468489046983911671876400248222449372029672832467076510649225676077)
(expect "is-know-root" 7100261737961175651894661471628070425717871781918545820690660904436371636492)
(expect "is-know-root" 433691966820481170835612732662415018601648678037719227187608695860310427976)
(expect "is-know-root" 7098826222200342209188065928557332008815532855779868708346378343137310353829)
(expect "is-know-root" 5761155846399808156424816482501372050616463271338541789615967734134838540609)

(print {"Total gas (insert-leaf)": (env-gas)})